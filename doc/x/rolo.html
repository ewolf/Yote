<!DOCTYPE html>
<html>

<!--

  LICENSE AND COPYRIGHT

  Copyright (C) 2014 Eric Wolf  ( coyocanid@gmail.com )
  This module is free software; it can be used under the terms of the artistic license

  ---------------------------------------------------------------------------------------------

  This html demonstrates the use of Yote templates to build a simple rolodex app that saves
  data locally to your browser local storage.

  Needed to work :
     This file

     yote.templates.js
     yote.util.js
     jquery
     json2.js

-->

  <head>
    <title>Rolodex</title>

    <style>
    .box {
        //border: solid 2px black;
         //background-color: #FEF;
        padding: 4px;
        margin: 4px;
        display: inline-block;
    }
    th {
        background-color: lightgrey;
        margin: 6px;
    }
    td {
        text-align: center;
        background-color: #eee;
        margin: 4px;
    }

    .editing {
        background-color: lightyellow;
        border: solid 2px black;
        padding-right: 10px;
        min-width:100px; }
    .edit_allowed {
        padding-right: 10px;
    }
    .example {
        background-color: lightyellow;
        display: block;
    }
    .comment {
        background-color: #EDB;
        display: inline-block;
    }
    .function {
        background-color: #BEB;
        display: inline-block;
    }
    .value {
        background-color: #BEE;
    }
    .showright {
        float:right;
        border: solid 1px black;
        margin: 2px;
        background-color: #8DF;
    }
    .hide { display: none; }
    </style>

    <script src="./yote/js/jquery-2.1.0.js"></script>
    <script src="./yote/js/yote.templates.js"></script>
    <script src="./yote/js/yote.util.js"></script>
    <script src="./yote/js/json2.js"></script>


    <script>

$().ready(function(){

    // fetch data from local storage or crete if none exists
    var rolo_data_raw = localStorage.getItem( 'rolodex' );
    var rolodex;
    if( rolo_data_raw ) {
        rolodex = { data : JSON.parse( rolo_data_raw ) };
    } else {
        rolodex = { data : [] };
    }
    rolodex.save = function() {
        localStorage.setItem( 'rolodex', JSON.stringify( this.data ) );
    }
    rolodex.remove_entry = function( idx ) {
        this.data.splice( idx, 1 );
        this.init();
        this.save();
    }
    rolodex.add_entry = function( entry ) {
        // entry should have name, email, phone
        entry.id = this.lastidx;
        this.lastidx++;
        if( ! entry.name ) entry.name = '';
        if( ! entry.phone ) entry.phone = '';
        if( ! entry.email ) entry.email = '';
        this.data.push( entry );
        this.names[ entry.name ]  = entry;
        this.phones[ entry.phone ] = entry;
        this.emails[ entry.email ] = entry;
        this.save();
    }
    rolodex.init = function() {
        var names  = {};
        var phones = {};
        var emails = {};
        this.lastidx = this.data.length
        for( var i=0, len = this.data.length; i < len ; i++ ) {
            var node = this.data[ i ];
            node.id = i;
            names[ node.name ] = node;
            phones[ node.phone ] = node;
            emails[ node.phone ] = node;
        }
        this.names  = names;
        this.phones = phones;
        this.emails = emails;
    };
    rolodex.search = function( str ) {
        if( ! str || str.trim().length == 0 ) return this.data;
        str = str.toLowerCase();
        var res = []
        for( var i=0, len = this.data.length; i < len ; i++ ) {
            var node = this.data[ i ];
            if( node.name.toLowerCase().indexOf( str ) >= 0 || node.phone.toLowerCase().indexOf( str ) >= 0 || node.email.toLowerCase().indexOf( str ) >= 0 ) {
                res.push( node );
            }
        }
        return res;
    }
    window.rolodex = rolodex;

    rolodex.init();

    $.yote.templates.init();
	$.yote.templates.refresh();

} ); //ready
    </script>

  </head>

  <templates>

    <script type="text/template" class="yote_template_definition" template_name="RoloSource">
      <$$$ show <a href="#"> $$$><span class="hide showhide">-</span><span class="showhide">+</span> show source for rolodex javascript object</a>
      <span class="hide showhide"">
<pre>
    // fetch data from local storage or crete if none exists
    var rolo_data_raw = localStorage.getItem( 'rolodex' );
    var rolodex;
    if( rolo_data_raw ) {
        rolodex = { data : JSON.parse( rolo_data_raw ) };
    } else {
        rolodex = { data : [] };
    }
    rolodex.save = function() {
        localStorage.setItem( 'rolodex', JSON.stringify( this.data ) );
    }
    rolodex.remove_entry = function( idx ) {
        this.data.splice( idx, 1 );
        this.init();
        this.save();
    }
    rolodex.add_entry = function( entry ) {
        // entry should have name, email, phone
        entry.id = this.lastidx;
        this.lastidx++;
        if( ! entry.name ) entry.name = '';
        if( ! entry.phone ) entry.phone = '';
        if( ! entry.email ) entry.email = '';
        this.data.push( entry );
        this.names[ entry.name ]  = entry;
        this.phones[ entry.phone ] = entry;
        this.emails[ entry.email ] = entry;
        this.save();
    }
    rolodex.init = function() {
        var names  = {};
        var phones = {};
        var emails = {};
        this.lastidx = this.data.length
        for( var i=0, len = this.data.length; i &lt; len ; i++ ) {
            var node = this.data[ i ];
            node.id = i;
            names[ node.name ] = node;
            phones[ node.phone ] = node;
            emails[ node.phone ] = node;
        }
        this.names  = names;
        this.phones = phones;
        this.emails = emails;
    };
    rolodex.search = function( str ) {
        if( ! str || str.trim().length == 0 ) return this.data;
        str = str.toLowerCase();
        var res = []
        for( var i=0, len = this.data.length; i &lt; len ; i++ ) {
            var node = this.data[ i ];
            if( node.name.toLowerCase().indexOf( str ) &gt;= 0 || node.phone.toLowerCase().indexOf( str ) &gt;= 0 || node.email.toLowerCase().indexOf( str ) &gt;= 0 ) {
                res.push( node );
            }
        }
        return res;
    }
    window.rolodex = rolodex;
    rolodex.init();
    </pre>
        </span>
      <?
          $( ctx.controls.show ).click( function() {
             $( '.showhide' ).toggleClass( 'hide' );
          } );
       ?>
    </script>

    <script type="text/template" class="yote_template_definition" template_name="Rolo">
      <#
           This is a simple rolodex that uses local storage for persistance.
           this means the data you enter will be available on the same browser on reload.
       #>
      <??? // run first in template created
            ctx.vars.rolodex = window.rolodex;
            ctx.vars.entry_count = rolodex.data.length;
      ???>
      <div class="box">
      Check out this rolodex. It has <$ entry_count $> entries.
      </div>
      <??  //only show the table if there are entries
         return ctx.vars.entry_count > 0 ? '<br><$$ PaginateEntries $$><br><$$ LookupEntry $$>' : '';
       ??>
      <br>
      <$$ AddEntry $$>
    </script>

    <script type="text/template" class="yote_template_definition" template_name="PaginateEntries">
      <???
            ctx.vars.entries = rolodex.search( ctx.scratch.search );
       ???>
      <div class="box">
       <?? return ctx.scratch.search ? 'searching for <b>' + ctx.scratch.search + '</b><br>' : '' ??>
       <table>
         <tr> <th> Name </th>  <th> Email </th>  <th> Phone </th> <th> Delete </th> </tr>
         <$$ ListPaginate EntryRow entries@@ 4 $$>
       </table>
      </div>
      <br>
      <$$ Paginator entries@@ $$>
    </script>

    <script type="text/template" class="yote_template_definition" template_name="EntryRow">
      <tr> <td> <$ _.name $> </td> <td> <$ _.email $> </td> <td> <$ _.phone $> </td> <td> <$$$ del <a href="#">$$$>delete</a> </td> </tr>
      <?  //remove the entry after a confirm
          $( ctx.controls.del ).click( function() {
              if( confirm( "remove this entry?" ) ) {
                  rolodex.remove_entry( ctx.vars._index_ );
                  ctx.refresh();
              }
          } );
       ?>
    </script>

    <script type="text/template" class="yote_template_definition" template_name="LookupEntry">
     <div class="box">
        <h3>Search</h3> for entries
        <??? return '<$$$ search <input placeholder="search" type="text" value="' +
                    (ctx.scratch.search ? ctx.scratch.search : '' ) +  '">$$$>'; ???>
             <$$$ go <button type="button">search</button> $$$>
     </div> <br>
     <?
         $.yote.util.button_actions( {
             button : ctx.controls.go,
             texts  : [ ctx.controls.search ],
             action : function() {
                 ctx.scratch.search = $( ctx.controls.search ).val();
                 ctx.refresh();
             }
         } );
      ?>
    </script>

    <script type="text/template" class="yote_template_definition" template_name="AddEntry">
      <div class="box">
       <h3>New Entry</h3>
       Name <$$$ name <input type="text"> $$$> <BR>
       Phone <$$$ phone <input type="text"> $$$> <BR>
       Email <$$$ email <input type="text"> $$$> <BR>
       <$$$ add <button type="button"> $$$>Add</button>
      </div>
      <? // run after template is rendered
           $.yote.util.button_actions( {
               button : ctx.controls.add,
               texts  : [ ctx.controls.name, ctx.controls.phone, ctx.controls.email ],
               action : function() {
                   rolodex.add_entry( {
                       name : $( ctx.controls.name ).val(),
                       phone : $( ctx.controls.phone ).val(),
                       email : $( ctx.controls.email ).val()
                   } );
                   ctx.refresh();
               }
           } );
       ?>
    </script>


  </templates>

  <body>
   <h1>Rolodex Demo</h1>
   <div  id="comments" class="yote_template showright" template="Rolo"></div>
   <div>
   <section>
     <h3>The Setup</h3>
     <p>
       The full source of this demo can of course be seen by viewing 
       sorce on this file. There is a <strong>rolodex</strong> javascript 
       object that uses local storage to fetch and store rolodex entries. 
       The purpose of this demo is not to show how to create such a creature
       but how it would fit in the templates.
     </p>
     <p>
       The api of this object, however, is relevant and the rolodex object
       has the following functions :
       <ul>
         <li><strong>add_entry</strong> - takes an object with name, 
           phone, email fields.</li>
         <li><strong>remove_entry</strong> - takes the index of the 
           entry and removes it.</li>
         <li><strong>search</strong> - takes a string and searches the 
           entries' data and returns a list of those entries that match.</li>
       </ul>
       Furthermore, this object is assigned to <strong>window</strong> 
       as <strong>window</strong>.<i>rolodex</i>.
     </p>
     <div  id="comments" class="yote_template" template="RoloSource"></div>
   </section>

   <section>
     <h3>Defining the first template</h3>
     <p>
       Outside of the body in the html document, the templates are defined with script tags. The
       tags include the class <i>yote_template_definition</i> and <i>template_name</i>. The <i>template_name</i>
       is used to include this template in an other or in the main document.
     </p>
     <pre>
       <code class="example">
  &lt;script type="text/template" class="yote_template_definition" template_name="<strong>Rolodex</strong>"&gt;

     <span class="comment">&lt;#
  This is a simple rolodex that uses local storage for persistance.
  this means the data you enter will be available on the same browser on reload.
#&gt;</span>

     <span class="function">&lt;???
   // this is a function body that is run before any other template tag in the creation of this template.
   // it assigns the rolodex variable to the context and stores how many items are in the rolodex.
   // the entry_count variable assigned below is used in the next div by the $ template tag.
   // the ??? template tag has the highest precidence except for comments. Anything assigned in here will
   // be visible to all lower precedence tags.

   ctx.vars.rolodex = window.rolodex;
   ctx.vars.entry_count = rolodex.data.length;
???&gt;</span>

     &lt;div class="box"&gt;
         Check out this rolodex. It has <span class="value">&lt;$ entry_count $&gt;</span> entries.
     &lt;/div&gt;

     <span class="function">&lt;??
   // only show entries and search for entries if there are entries.
   // the ?? function has a higher precidence than the $$ include template tag.
   // the output of this becomes part of the template, and any other template tags contained
   // within are executed afterwards as long as they have lower precedence.

   return ctx.vars.entry_count &gt; 0 ? '&lt;br&gt;<span class="value">&lt;$$ PaginateEntries $$&gt;</span>&lt;br&gt;' +
       '<span class="value">&lt;$$ LookupEntry $$&gt;</span>&lt;br&gt;' : '';
??&gt;</span>

     <span class="comment">&lt;# insert the AddEntry template into this one. #&gt;</span>
     <span class="value">&lt;$$ AddEntry $$&gt;</span>

  &lt;/script&gt;
       </code>
     </pre>
   </section>

   <section>
     <h3>Inserting the templates into the body</h3>
     <p>
       Before the rest of the templates are defined, this section shows how to insert
       the templates into your document. The first part is easy : just include a div of
       class <strong>yote_template</strong> and give it the <strong>template</strong> attribute
       with the value as the name of the template you want to insert.
     </p>

     <pre>
       <code class="example">
 &lt;body&gt;
   &lt;div  class="yote_template" template="Rolo"&gt;&lt;/div&gt;
 &lt;/body&gt;
       </code>
     </pre>

     <p>
       The template system still must be activated and the template filled in.
       This is done using javascript. We are going to use jquery's ready method
       to do the activation in. The init method, then the refresh method must be called.
       The init method finds all discovered templates and compiles them into javascript
       functions.  The refresh method then fills in the templates.
     </p>

     <pre>
       <code class="example">
   $().ready( function() {
        $.yote.templates.init();
        $.yote.templates.refresh();
   } );
       </code>
     </pre>

   </section>

   <section>
     <h3>Defining the rest of the templates</h3>
     <p>
       The <strong>Rolodex</strong> template had a few other templates it needed inserted into it. Those are
       namely <strong>AddEntry, LookupEntry</strong> and <strong> PaginateEntries</strong>. An
       <strong>EntryRow</strong> template is also needed in order to show multiple items
         in the rolodex at once.
     </p>
     <p>
       As is sounds, AddEntry template has inputs to add new entries to the 
       rolodex. The controls assigned are unique to this context and are 
       copied to any children contexts of this one. After the html is
       rendered, the button_actions function is run and it links up
       the controls to the rolodex object.
     </p>
     <pre>
       <code class="example">
  &lt;script type="text/template" class="yote_template_definition" template_name="<strong>AddEntry</strong>"&gt;
      &lt;div class="box"&gt;
       &lt;h3&gt;New Entry&lt;/h3&gt;
       Name <span class="value">&lt;$$$ name &lt;input type="text"&gt; $$$&gt;</span> &lt;BR&gt;
       Phone <span class="value">&lt;$$$ phone &lt;input type="text"&gt; $$$&gt;</span> &lt;BR&gt;
       Email <span class="value">&lt;$$$ email &lt;input type="text"&gt; $$$&gt;</span> &lt;BR&gt;
       <span class="value">&lt;$$$ add &lt;button type="button"&gt; $$$&gt;</span> Add&lt;/button&gt;
      &lt;/div&gt;
      <span class="function">&lt;? // run after template is rendered.
   // Button actions runs the action when the text inputs are filled in and
   // runs the action. The rolodex object ( outlined above ) runs the add
   // entry method and then all the templates are refreshed.
      $.yote.util.button_actions( {
          button : ctx.controls.add,
          texts  : [ ctx.controls.name, ctx.controls.phone, ctx.controls.email ],
          action : function() {
              rolodex.add_entry( {
                  name : $( ctx.controls.name ).val(),
                  phone : $( ctx.controls.phone ).val(),
                  email : $( ctx.controls.email ).val()
              } );
              ctx.refresh();
          }
       } );
       ?&gt;</span>
    &lt;/script&gt;
  &lt;/script&gt;
       </code>
     </pre>
     <p>
       
     </p>
     <pre>
       <code class="example">

  &lt;script type="text/template" class="yote_template_definition" template_name="<strong>PaginateEntries</strong>"&gt;

      <span class="function">&lt;???
    ctx.vars.entries = rolodex.search( ctx.scratch.search );
???&gt;</span>

      &lt;div class="box"&gt;

       <span class="function">&lt;?? return ctx.scratch.search ? 'searching for &lt;b&gt;' + ctx.scratch.search + '&lt;/b&gt;&lt;br&gt;' : '' ??&gt;</span>

       &lt;table&gt;
         &lt;tr&gt; &lt;th&gt; Name &lt;/th&gt;  &lt;th&gt; Email &lt;/th&gt;  &lt;th&gt; Phone &lt;/th&gt; &lt;th&gt; Delete &lt;/th&gt; &lt;/tr&gt;

         <span class="comment">&lt;# ListPaginate is a standard yote template included by default. It takes 3 arguments <ul><li>template to fill with each item in the list</li><li>the list</li><li>the maximum number in that list to show</li></ul> The @@ in the entries@@ indicates that the variable should be interpreted as a paginated list. 
 Were it a single @ character, it would be interpreted as a normal list. 
#&gt;</span>

         <span class="value">&lt;$$ ListPaginate EntryRow entries@@ 4 $$&gt;</span>

       &lt;/table&gt;
      &lt;/div&gt;
      &lt;br&gt;
      &lt;$$ Paginator entries@@ $$&gt;
  &lt;/script&gt;
       </code>
     </pre>
     <p>
       
     </p>
     <pre>
       <code class="example">

  &lt;script type="text/template" class="yote_template_definition" template_name="<strong>EntryRow</strong>"&gt;
  &lt;/script&gt;
      &lt;tr&gt; 
        &lt;td&gt; &lt;$ _.name $&gt; &lt;/td&gt; 
        &lt;td&gt; &lt;$ _.email $&gt; &lt;/td&gt; 
        &lt;td&gt; &lt;$ _.phone $&gt; &lt;/td&gt;
        &lt;td&gt; <span class="value">&lt;$$$ del &lt;a href="#"&gt;$$$&gt;</span>delete&lt;/a&gt; &lt;/td&gt;
      &lt;/tr&gt;
      <span class="function">&lt;?  //remove the entry after a confirm
    $( ctx.controls.del ).click( function() {
        if( confirm( "remove this entry?" ) ) {
            rolodex.remove_entry( ctx.vars._index_ );
            ctx.refresh();
        }
    } );
?&gt;</span>
  &lt;/script&gt;
       </code>
     </pre>

     <pre>
       <code class="example">

  &lt;script type="text/template" class="yote_template_definition" template_name="<strong>LookupEntry</strong>"&gt;
     &lt;div class="box"&gt;
        &lt;h3&gt;Search&lt;/h3&gt; for entries

        <span class="function">&lt;???
   // build a search input and start it off with the value of search, if any.
   // scratch is a lookup table in the context that is shared by every context.

   return '&lt;$$$ search &lt;input placeholder="search" type="text" value="' +
             (ctx.scratch.search ? ctx.scratch.search : '' ) +  '"&gt;$$$&gt;';
???&gt; </span>

        <span class="comment">&lt;# assigns an id to the button and ads it to the controls lookup in the context with the name go #&gt;</span>
        <span class="value">&lt;$$$ go &lt;button type="button"&gt;$$$&gt;search&lt;/button&gt;</span>

    &lt;/div&gt;

   <span class="function">&lt;?
  // the ? tag is run <i>after</i> the template is rendered. This allows event handlers to
  // be attached to the controls in the template.
  // button actions wires up text inputs and a button with the behavior that the button is not
  // enabled until the text inputs are full.
  // The action is what happens when the button is pressed or enter is hit when the
  // focus is on the last text input.
  $.yote.util.button_actions( {
      button : ctx.controls.go,
      texts  : [ ctx.controls.search ],
      action : function() {
          ctx.scratch.search = $( ctx.controls.search ).val();
          ctx.refresh();
      }
  } );
?&gt;</span>
&lt;/script&gt; </code> </pre>
   </section>
   </div>
 </body>

<!-- the templates below this line live in default_templates.html. They are included directly here
     because html cannot easily be included in other html when loaded from the file system - it
     encounters all sorts of CORS problems.
  -->

<script type="text/template" class="yote_template_definition" template_name="ListPaginate">
    <#
        fills the template for each item in the list up to pagination size.
           remembers pagination state across reloads
        arguments :
            template
            paginated list object
            size of pagination

        Adds the following variables to the context :
            _       : list item being rendered
            _index_ : the index of the item in the list

        Paginated list objects are specified by @@

        Example : <$$ ListPaginate myTemplate myList@@ 10 $$>
     #>
    <???

    if( ctx.args.length > 1 ) {
        var template = ctx.args[ 0 ];
        var pag_list = ctx.parent.parse( ctx.args[ 1 ] );
        var size     = ctx.args[ 2 ];
        var more     = ctx.args.length > 3 ? ctx.args.slice( 3 ) : [];
        pag_list.set_size( size );
        return pag_list.to_list().map( function ( item, idx ) {
            return '<$$ _listfillpagrow ' + template + ' ' + ctx.args[ 1 ] + ' ' + idx + ' ' + more.join(' ') + ' $$>';
        } ).join('');
    }
    console.log( 'error in template ListPaginate : not enough arguments ( requires 2 ) : ' + '<$$ ListPaginate ' + ctx.args.join(' ') + ' $$>' );
    return '';
    ???>
</script>

<script type="text/template" class="yote_template_definition" template_name="_listfillpagrow">
   <???
      var template = ctx.args[ 0 ]; // fillpagrow
      var pag_list = ctx.parent.parent.parse( ctx.args[ 1 ] );
      var list     = pag_list.to_list();
      var idx      = ctx.args[ 2 ];
      var more = ctx.args.length > 3 ? ctx.args.slice( 3 ) : [];
      ctx.vars._ = list[ idx ];
      ctx.vars._index_ = Number(idx) + pag_list._start;
      return '<$$ ' + template + ' ' + more.join( ' ' ) + ' $$>';
    ???>
</script>

<script type="text/template" class="yote_template_definition" template_name="Paginator">
 <???
     var collection = ctx.parent.parse( ctx.args[ 0 ] );
     if( collection.can_rewind() || collection.can_fast_forward() ) {
         return '<$$$ paginate_to_beginning_button <button type="BUTTON">&laquo;</button> $$$>' +
      '<$$$ paginate_back_button <button type="BUTTON">&lsaquo;</button> $$$>' +
      '<$$$ paginate_forward_button <button type="BUTTON">&rsaquo;</button> $$$>' +
      '<$$$ paginate_to_end_button <button type="BUTTON">&raquo;</button> $$$>';
     }
      return '';
  ???>
 <?

     if( ctx.args.length < 1 ) return;

     var collection = ctx.parent.parse( ctx.args[ 0 ] );

     if( ! collection || ! collection.can_rewind ) { //test if it has that function
         console.log( 'warning : init_paginator called for something not a list or hash' );
         return;
     }
     var pag_begin_button_id    = ctx.controls.paginate_to_beginning_button,
          pag_back_button_id    =  ctx.controls.paginate_back_button,
          pag_forward_button_id =  ctx.controls.paginate_forward_button,
          pag_end_button_id     =  ctx.controls.paginate_to_end_button;

     if( collection.can_rewind() ) {
         $( pag_begin_button_id ).attr( 'disabled', false );
         $(  pag_back_button_id ).attr( 'disabled', false );
         $(  pag_begin_button_id ).click( function() {
                           collection.first();
                           $.yote.reinit();
                           ctx.refresh();
                           } );
         $(  pag_back_button_id ).click( function() {
                           collection.back();
                           $.yote.reinit();
                           ctx.refresh();
                           } );
     } else {
         $(  pag_begin_button_id ).attr( 'disabled', true );
         $(  pag_back_button_id ).attr( 'disabled', true );
     }
     if( collection.can_fast_forward() ) {
         $(  pag_forward_button_id ).attr( 'disabled', false );
         $(  pag_end_button_id ).attr( 'disabled', false );
         $(  pag_forward_button_id ).click( function() {
             collection.forwards();
             $.yote.reinit();
             ctx.refresh();
         } );
         $(  pag_end_button_id ).click( function() { collection.last();
                                                     $.yote.reinit();
                                                     ctx.refresh(); } );
     } else {
         $(  pag_forward_button_id ).attr( 'disabled', true );
         $(  pag_end_button_id ).attr( 'disabled', true );
     }
  ?>
</script>

</html>
