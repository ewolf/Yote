<!DOCTYPE html>
<html>

<!--

  LICENSE AND COPYRIGHT

  Copyright (C) 2014 Eric Wolf  ( coyocanid@gmail.com )
  This module is free software; it can be used under the terms of the artistic license

  ---------------------------------------------------------------------------------------------

  This html demonstrates the use of Yote templates to build a simple rolodex app that saves
  data locally to your browser local storage.

  Needed to work :
     This file

     yote.templates.js
     yote.util.js
     jquery
     json2.js

-->

  <head>
    <title>Interactive Template Demo</title>

    <style>
    .box {
        border: solid 2px black;
         //background-color: #FEF;
        padding: 4px;
        margin: 4px;
    }
    </style>

    <script src="/yote/js/jquery-2.1.0.js"></script>
    <script src="/yote/js/yote.templates.js"></script>
    <script src="/yote/js/yote.util.js"></script>
    <script src="/yote/js/json2.js"></script>


    <script>
    window.sample_sets = {
        hello : [
            { name : "hello", //first template must have same name as set
              body :
              'To whom am I speaking ? <$$$ name <input type="text" placeholder="your name"> $$$>\n' +
	      '<br>\n' +
	      '<$$$ go <button type="button"> $$$> click me </button>\n' +
	      '<? \n' +
              '  $( ctx.controls.name ).val( ctx.scratch.name || "" ); //last set value\n' + 
              '  $( ctx.controls.go ).click( function() { \n' +
              '         ctx.scratch.name = $( ctx.controls.name ).val() || "unknown person";\n' + 
	      '         alert( "Hello " + ctx.scratch.name );\n' +
	      '      } );\n' +
              '?>'
            }
        ],
        rolodex : [
            { name  : "rolodex", //first template must have same name as set
              notes : 'master template',
              body  :
              '<#\n' +
              '    This is a simple rolodex that uses local storage for persistance.\n' +
              '    this means the data you enter will be available on the same browser on reload.\n' +
              '#>\n' +
              '<??? // run first in template created\n' +
              '    // fetch data from local storage or crete if none exists\n' +  
              '    var rolo_data_raw = localStorage.getItem( "rolodex" );\n' +  
              '    var rolodex;\n' +  
              '    if( rolo_data_raw ) {\n' +  
              '        rolodex = { data : JSON.parse( rolo_data_raw ) };\n' +  
              '    } else {\n' +  
              '        rolodex = { data : [] };\n' +  
              '    }\n' +  
              '    rolodex.save = function() {\n' +  
              '        localStorage.setItem( "rolodex", JSON.stringify( this.data ) );\n' +  
              '    }\n' +  
              '    rolodex.remove_entry = function( idx ) {\n' +  
              '        this.data.splice( idx, 1 );\n' +  
              '        this.init();\n' +  
              '        this.save();\n' +  
              '    }\n' +  
              '    rolodex.add_entry = function( entry ) {\n' +  
              '        // entry should have name, email, phone\n' +  
              '        entry.id = this.lastidx;\n' +  
              '        this.lastidx++;\n' +  
              '        if( ! entry.name ) entry.name = "";\n' +  
              '        if( ! entry.phone ) entry.phone = "";\n' +  
              '        if( ! entry.email ) entry.email = "";\n' +  
              '        this.data.push( entry );\n' +  
              '        this.names[ entry.name ]  = entry;\n' +  
              '        this.phones[ entry.phone ] = entry;\n' +  
              '        this.emails[ entry.email ] = entry;\n' +  
              '        this.save();\n' +  
              '    }\n' +  
              '    rolodex.init = function() {\n' +  
              '        var names  = {};\n' +  
              '        var phones = {};\n' +  
              '        var emails = {};\n' +  
              '        this.lastidx = this.data.length\n' +  
              '        for( var i=0, len = this.data.length; i < len ; i++ ) {\n' +  
              '            var node = this.data[ i ];\n' +  
              '            node.id = i;\n' +  
              '            names[ node.name ] = node;\n' +  
              '            phones[ node.phone ] = node;\n' +  
              '            emails[ node.phone ] = node;\n' +  
              '        }\n' +  
              '        this.names  = names;\n' +  
              '        this.phones = phones;\n' +  
              '        this.emails = emails;\n' +  
              '    };\n' +  
              '    rolodex.search = function( str ) {\n' +  
              '        if( ! str || str.trim().length == 0 ) return this.data;\n' +  
              '        str = str.toLowerCase();\n' +  
              '        var res = []\n' +  
              '        for( var i=0, len = this.data.length; i < len ; i++ ) {\n' +  
              '            var node = this.data[ i ];\n' +  
              '            if( node.name.toLowerCase().indexOf( str ) >= 0 || node.phone.toLowerCase().indexOf( str ) >= 0 || node.email.toLowerCase().indexOf( str ) >= 0 ) {\n' +  
              '                res.push( node );\n' +  
              '            }\n' +  
              '        }\n' +  
              '        return res;\n' +  
              '    }\n' +  
              '    window.rolodex = rolodex;\n' +  
              '\n' +  
              '    rolodex.init();\n' +  
              '    ctx.vars.rolodex = window.rolodex;\n' +
              '    ctx.vars.entry_count = rolodex.data.length;\n' +
              '???>\n' +
              '<div class="box">\n' +
              '  Check out this rolodex. It has <$ entry_count $> entries.\n' +
              '</div>\n' +
              '<??  //only show the table if there are entries\n' +
              '   return ctx.vars.entry_count > 0 ? "<br><$$ PaginateEntries $$><br><$$ LookupEntry $$>" : "";\n' +
              '??>\n' +
              '<br>\n' +
              '<$$ AddEntry $$>'
            },
            { name : "PaginateEntries",
              body :
              '<???\n' +
              '      ctx.vars.entries = rolodex.search( ctx.scratch.search );\n' +
              '???>\n' +
              '<div class="box">\n' +
              '  <?? return ctx.scratch.search ? "searching for <b>" + ctx.scratch.search + "</b><br>" : "" ??>\n' +
              '  <table>\n' +
              '   <tr> <th> Name </th>  <th> Email </th>  <th> Phone </th> <th> Delete </th> </tr>\n' +
              '   <$$ ListPaginate EntryRow entries@@ 4 $$>\n' +
              '  </table>\n' +
              '</div>\n' +
              '<br>\n' +
              '<$$ Paginator entries@@ $$>\n'
            },
            { name : "EntryRow",
              body :
              '<tr> <td> <$ _.name $> </td> <td> <$ _.email $> </td> <td> <$ _.phone $> </td> <td> <$$$ del <a href="#">$$$>delete</a> </td> </tr>\n' +
              '<?  //remove the entry after a confirm\n' +
              '   $( ctx.controls.del ).click( function() {\n' +
              '       if( confirm( "remove this entry?" ) ) {\n' +
              '          rolodex.remove_entry( ctx.vars._index_ );\n' +
              '          ctx.refresh();\n' +
              '       }\n' +
              '    } );\n' +
              '?>\n'
            },
            { name : 'LookupEntry',
              body :
              '<div class="box">\n' +
              '  <h3>Search</h3> for entries\n' +
              '  <??? return ' + "'" + '<$$$ search <input placeholder="search" type="text" value="' + "'" + ' + \n' +
              '        (ctx.scratch.search ? ctx.scratch.search : "" ) +  ' + "'" + '">$$$>' + "'" + '; ???>\n' +
              '     <$$$ go <button type="button">search</button> $$$>\n' +
              '</div> <br>\n' +
              '<?\n' +
              '    $.yote.util.button_actions( {\n' +
              '        button : ctx.controls.go,\n' +
              '        texts  : [ ctx.controls.search ],\n' +
              '        action : function() {\n' +
              '            ctx.scratch.search = $( ctx.controls.search ).val();\n' +
              '            ctx.refresh();\n' +
              '        }\n' +
              '    } );\n' +
              ' ?>\n'
            },
            { name : 'AddEntry',
              body :
              '<div class="box">\n' +
              '  <h3>New Entry</h3>\n' +
              '  Name <$$$ name <input type="text"> $$$> <BR>\n' +
              '  Phone <$$$ phone <input type="text"> $$$> <BR>\n' +
              '  Email <$$$ email <input type="text"> $$$> <BR>\n' +
              '  <$$$ add <button type="button"> $$$>Add</button>\n' +
              '</div>\n' +
              '<? // run after template is rendered\n' +
              '    $.yote.util.button_actions( {\n' +
              '        button : ctx.controls.add,\n' +
              '        texts  : [ ctx.controls.name, ctx.controls.phone, ctx.controls.email ],\n' +
              '        action : function() {\n' +
              '            rolodex.add_entry( {\n' +
              '                name : $( ctx.controls.name ).val(),\n' +
              '                phone : $( ctx.controls.phone ).val(),\n' +
              '                email : $( ctx.controls.email ).val()\n' +
              '            } );\n' +
              '            ctx.refresh();\n' +
              '        }\n' +
              '    } );\n' +
              '?>\n'
            }
        ],
        blank : [ { name : 'start', body : '', notes : 'write your own here' } ]
    };

$().ready(function(){
    $.yote.templates.import_templates( "/templates/default_templates.html" );

    window.sets = JSON.parse( localStorage.getItem( 'template_sets' ) || '""' ) || window.sample_sets;
    var show_set = localStorage.getItem( 'cur_set' ) || 'hello';
    var show_template = $( '#results_tmp' ).html() || window.sample_sets[ show_set ][ 0 ].name;

    function reg( tmpl ) { 
        try {
            $.yote.templates.register_template( tmpl.name, tmpl.body );
        } catch( err ) {
            console.log( err );
            tmpl.err = err.message;
            $.yote.templates.unregister_template( tmpl.name );
            localStorage.setItem( 'template_sets', JSON.stringify( sets ) );
        }
    }
    for( sname in sets ) {
        var set = sets[ sname ];
        for( var i=0, len=set.length; i<len; i++  ) {
            reg( set[i] );
        }
    }

    
    $( '#results' ).html( '<h3>The results of template "' + show_template + '"</h3><div class="box">' +
                          '<div id="comments"><$$ ' + show_template + ' $$></div>' );

    $.yote.templates.init();
    $.yote.templates.refresh();
} ); //ready
    </script>

  </head>

  <templates>

    <script type="text/template" class="yote_template_definition" template_name="TemplateRow">
      <div class="box">
        <b>template name :</b>
        <$$$ name <input type="text" value="">$$$>
        <$$$ del <button type="button">$$$>delete</button>
        <$$$ render <button type="button">$$$>render</button>
        <$$$ notediv <div style="display:none"> $$$>
          <br>
          <$$$ notes <input type="text" placeholder="template notes">$$$>
          </div>
        <br>
        <b>template body :</b>
        <br>
        <$$$ body <textarea cols="80"></textarea> $$$>
        <br>
        <$$$ apply <button type="button"$$$>>Apply</button>
        <br>
        <$$$ errpanel <div></div>$$$>
        <?
          if( ctx.vars._.notes ) {
              $( ctx.controls.notes ).append( ctx.vars._.notes );
              $( ctx.controls.notediv ).show();
          }
          if( ctx.vars._.err ) {
              $( ctx.controls.errpanel ).html( '<b>error compiling template</b> : ' + ctx.vars._.err );
          }
          $( ctx.controls.render ).click( function() {
              ctx.scratch.showing_template = ctx.vars._.name;
              ctx.refresh();
          } );
          var blen = 3;
          if( ctx.vars._.body ) {
             var c = ctx.vars._.body.match( /\n/g );
             if( c ) { blen += c.length; }
          }
          if( blen > 30 ) blen = 30;
          $( ctx.controls.body ).text( ctx.vars._.body ).attr( 'rows', blen );
          $( ctx.controls.del ).click(function() {
              if( confirm( 'are you sure you want to delete template "' + ctx.vars._.name + '"' ) ) {
                  delete ctx.vars.current_set[ ctx.vars._index_ ];
                  localStorage.setItem( 'template_sets', JSON.stringify( ctx.vars.sample_sets ) );
                  ctx.refresh();
              }
           } );
          $( ctx.controls.name ).val( ctx.vars._.name );
          $( ctx.controls.apply ).click( function() {
              var tmpl = { name: $(ctx.controls.name).val(), body:$( ctx.controls.body).val() };
              ctx.vars.current_set[ ctx.vars._index_ ] = tmpl;
              localStorage.setItem( 'template_sets', JSON.stringify( ctx.vars.sample_sets ) );
              ctx.refresh();
          } );
        ?>
      </div>
    </script>

    <script type="text/template" class="yote_template_definition" template_name="SetRow">
      <li><$$$ showset <a href="#">$$$><$ _hashkey_ $></a></li>
      <? 
         if( ctx.scratch.current_set_name == ctx.vars._hashkey_ ) {
             $( ctx.controls.showset ).css( 'font-weight', 'bold' );
         }
         $( ctx.controls.showset ).click( function() {
             var set = ctx.vars.sample_sets[ ctx.vars._hashkey_ ];
             ctx.scratch.current_set_name = ctx.vars._hashkey_;
             ctx.scratch.showing_template = set[ 0 ].name;
             localStorage.setItem( 'cur_set', ctx.scratch.current_set_name );
             $( '#results' ).empty().html( '<h3>The results of template "' + set[ 0 ].name + '"</h3><div class="box">' +
                                           '<div id="comments"><' + '$$ ' + set[ 0 ].name + ' $$' + '></div>' );
             ctx.refresh();
         } );
         ?>
    </script>

    <script type="text/template" class="yote_template_definition" template_name="TryTemplates">
      <???
         ctx.vars.sample_sets = window.sets;
         ctx.scratch.current_set_name = localStorage.getItem( 'cur_set' );
         if( ! ctx.scratch.current_set_name ) {
             alert( 'no name' );
             ctx.scratch.current_set_name = 'hello';
         }
         if( ! ctx.scratch.showing_template ) {
             ctx.scratch.current_template = ctx.vars.sample_sets[ ctx.scratch.current_set_name ][ 0 ];
             ctx.scratch.showing_template = ctx.scratch.current_template.name;
         }
         ctx.vars.current_set_name  = ctx.scratch.current_set_name;
         ctx.vars.current_set = ctx.vars.sample_sets[ ctx.scratch.current_set_name ];
         
	 ???>
      <$$$ results <div></div> $$$>
      <div class="box">
        <h3>Sample Template Sets</h3>
        <p>
           Here are a few sample template sets. The 'blank' set is 
           empty so you can create your own templates there.
        </p>
        <ul><$$ Hash SetRow sample_sets% $$></ul>
        <$$$ resetb <a href="#">reset to defaults</a> $$$>
      </div>
      <div class="box">
        <h3>Edit Templates for Set <$ current_set_name $></h3>
        <$$$ delete_all <a href="#">delete all</a> $$$>
        <$$ List TemplateRow current_set@ $$>
      </div>
      <div class="box">
        <h3>Create New Template for this set</h3>
        <$$$ newtname <input type="text" placeholder="template name">$$$>
        <br>
        <$$$ newtbody <textarea placeholder="template body" cols="80" rows="4">$$$></textarea>
        <br>
        <$$$ newt <button type="button">$$$>New Template</button>
      </div>
      <div class="box">
        <$$$ go <button type="button">$$$>Render</button>
      </div>

      <?
         $.yote.util.button_actions( {
             button : ctx.controls.newt,
             texts  : [ ctx.controls.newtname ],
             action : function() {
                 var newt = { name : $( ctx.controls.newtname ).val(), body : $( ctx.controls.newtbody ).val() };
                 ctx.vars.current_set.push( newt );
                 localStorage.setItem( 'template_sets', JSON.stringify( ctx.vars.sample_sets ) );
                 ctx.refresh();
             }
         } );
         $( ctx.controls.resetb ).click( function() {
             if( confirm( "really reset all sets?" ) ) {
                 localStorage.setItem( 'template_sets', JSON.stringify( window.sample_sets ) );
                 ctx.scratch.current_set_name = undefined;
                 ctx.scratch.showing_template = undefined;
                 ctx.refresh();
             }
         } );
         $( ctx.controls.delete_all ).click( function() {
             if( confirm( "really delete all templates for this set?" ) ) {
                 ctx.vars.sample_sets[ ctx.scratch.current_set_name ] = [];
                 localStorage.setItem( 'template_sets', JSON.stringify( ctx.vars.sample_sets ) );
                 ctx.refresh();
             }
         } );
       ?>
    </script>
  </templates>

  <hr>

  <body>
    <h1>Interactive Template Demo</h1>
    <p>
      View, modify and create demo templates. Pick from sets of sample templates on the left 
      side of the page to see its source code. You can modify the source and the result will 
      appear on the right side of the page.
    </p>
    <p>
      In this demo, templates are grouped into sets. A 'set' is a set of templates that
      perform a similar function. The examples automatically include the default templates
      like <b>Hash</b> and <b>List</b>. The <b>$.yote.util</b> library is also included 
      for its <i>button_actions</i> function.
    </p>
    <p>
      
    </p>
    Yote templates are described in detail
    <a href="http://madyote.com/templates.html">here.</a>
    <div>
      <span style="display:none" id="results_tmp"></span>
      <div style="float:right" id="results"></div>
      <$$ TryTemplates $$>
    </div>
  <hr>

  <section>
    <h3>Tag Cheat Sheet</h3>
    <h4>In order of Precedence</h4>
    <dl>
      <dt>&lt;# comments #&gt;</dt>
      <dd>

      </dd>
      <dt>&lt;??? <i>javascript function body</i> ???&gt;</dt>
      <dd>
        The body is wrapped with <strong>function(ctx) { ... }</strong> and the return value
        (if any) is inserted into the template. Anything added to the context is visible
        to all lower precedent tags. The return value can build lower precedence tags
        dynamically too.
        <br>
        Example <span class="demo">&lt??? return use_a ? '&lt;$$ ATemplate $$&gt;' : '&lt;$$ BTemplate $$&gt;'; ???&gt;</span>
      </dd>
      <dt>&lt;$$$ control-name <i>html of opening tag of control</i>  $$$&gt;</dt>
      <dd>
        This generates a unique id for the control and assigns it to it and assigns the id value to control_ids and
        id value prepended with '#' to controls.
        <br>
        Example <span class="demo">&lt$$$ myButton &lt;button type="button"&gt; $$$&gt;Clickme&lt;/button&gt;</span>
      </dd>
      <dt>&lt;?? <i>javascript function body</i>   ??&gt;</dt>
      <dd>
        The body is wrapped with <strong>function(ctx) { ... }</strong> and the return value
        (if any) is inserted into the template. Anything added to the context is visible
        to all lower precedent tags. The return value can build lower precedence tags
        dynamically too.
        <br>
        Example <span class="demo">&lt?? return '&lt;label for="' + ctx.control_ids.check  + '"&gt;';  ??&gt;&lt$$$ check &lt;input type="checkbox"&gt;n $$$&gt;</span>
      </dd>
      <dt>&lt;$$ template-to-insert <i>space-separated-arguments</i> $$&gt;</dt>
      <dd>
      </dd>
      <dt>&lt;$ context-variable <i>"default value"</i> $&gt;</dt>
      <dd>
      </dd>
      <dt>&lt;? <i>javascript function body</i>   ?&gt;</dt>
      <dd>
      </dd>
    </dl>
    </div>
  </section>


</html>
