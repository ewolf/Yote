<!DOCTYPE html>
<html>
<!-- Bootstrappy and meta. This page could replace itself -->
  <head>
    <title>Yote Admin 3</title>
    <script src="/yote/js/jquery-latest.js"></script>
    <script src="/yote/js/jquery.cookie.js"></script>
    <script src="/yote/js/jquery.base64.min.js"></script>
    <script src="/yote/js/json2.js"></script>

    <script src="/js/main.js"></script>
    <script src="/yote/js/yote.js"></script>
    <script src="/yote/js/yote.util.js"></script>
    <link href="/yote.css" rel="stylesheet" type="text/css" media="all" />
    <link href="/css/main.css" rel="stylesheet" type="text/css" media="all" />

    <META NAME="Author" CONTENT="Eric Wolf, coyocanid@gmail.com">

    <STYLE>
      .mainpanel { top:0px; width:900px; display:inline-block; }
      .tabs {
	  position: relative;
	  min-height: 300px; /* This part sucks */
	  clear: both;
	  margin: 25px 0;
      }
      .tab {
	  float: left;
      }
      .tab label {
	  background: #eee;
	  padding: 10px;
	  border: 1px solid #ccc;
	  margin-left: -1px;
	  position: relative;
	  left: 1px;
      }
      .tab [type=radio] {
	  display: none;
      }
      .content {
	  position: absolute;
	  top: 28px;
	  left: 0;
	  background: white;
	  right: 0;
	  bottom: 0;
	  padding: 20px;
	  border: 1px solid #ccc;
      }
      [type=radio]:checked ~ label {
	  background: white;
	  border-bottom: 1px solid white;
	  z-index: 2;
      }
      [type=radio]:checked ~ label ~ .content {
	  z-index: 1;
      }
      .apppanel { margin-left: 150px; }
      .sidenav { float: left; text-align: center; }
      button.sidenav {     background:none!important; cursor:pointer;
     border:none;
     padding:0!important;
    /*border is optional*/
     border-bottom:1px solid #444; ; }
      ._ct_row { vertical-align: top }
      ._ct_cell { border: 6px rgb(120,226,165) groove }
    </STYLE>

<!--
there is a beauty that we experience as kids that only leaves tiny hints of itself when we are older.
it hides in smells and in the whispered wind.
if we are our experiences then we are both sides of them.

-->

    <script>
      var root;
      $().ready(function(){
	  $( '#mainpanel' ).hide();
	  $.yote.debug = false;
	  $.yote.init();

	  $( 'button.sidenav' ).each( function( idx, domEl ) {
	      $(this).click(function(){
		  $( '.apppanel' ).hide();
		  $( '#' + $(this).attr('id') + '_div' ).show();
	      });
	  } );

	  // -------------------------------------

	  $.yote.util.register_functions( {
	      cron_entry_next_time : function( args ) {
		  var entry = args[ 'default_var' ];
		  return entry.get( 'next_time' ) > 0 ? '<nobr>' +  $.yote.util.format_date( new Date( 60 * 1000 * entry.get( 'next_time' ) ), "h:m Y-M-D" ) + '</nobr>' : 'Not Scheduled';
	      },
	      app_user_count : function( args ) {
		  var app = args[ 'default_var' ];
		  return app.count('_account_roots');
	      },
	      make_root : function( is_checked, user ) {
		  if( is_checked ) {
		      root.make_root( user );
		  }
		  else {
		      root.remove_root( user, function(){},function(err){ alert(err)} );
		  }
	      },
	      delete_repeat : function( args ) {
		  args[ 'default_parent' ].remove_from( { name : 'repeats', items : [ args[ 'default_var' ] ] } );
		  $.yote.util.refresh_ui();
	      },
	      root_status : function( args ) {
		  var login = args[ 'default_var' ];
		  return login.is_master_root() ? 'master root' : '<$ switch make_root ' + (1*login.is_root() != 0 ? '1' : '') + '$>';
	      },
	      is_validated : function( args ) {
		  var login = args[ 'default_var' ];
		  return login.is_validated() ? "Yes" : "No";
	      },
	      init_paginator : function( args ) {
		  var collection = args[ 'default_var' ];
		  var pag_begin_button_id = args[ 'vars' ][ 'paginate_to_beginning_button' ],
                      pag_back_button_id =  args[ 'vars' ][ 'paginate_back_button' ],
                      pag_forward_button_id =  args[ 'vars' ][ 'paginate_forward_button' ],
                      pag_end_button_id =  args[ 'vars' ][ 'paginate_to_end_button' ];

		  if( collection.can_rewind() ) {
		      $( '#' + pag_begin_button_id ).attr( 'disabled', false );
		      $( '#' + pag_back_button_id ).attr( 'disabled', false );
		      $( '#' + pag_begin_button_id ).click( function() { collection.first(); refresh_all(); } );
		      $( '#' + pag_back_button_id ).click( function() { collection.back(); refresh_all(); } );
		  } else {
		      $( '#' + pag_begin_button_id ).attr( 'disabled', true );
		      $( '#' + pag_back_button_id ).attr( 'disabled', true );
		  }
		  if( collection.can_fast_forward() ) {
		      $( '#' + pag_forward_button_id ).attr( 'disabled', false );
		      $( '#' + pag_end_button_id ).attr( 'disabled', false );
		      $( '#' + pag_forward_button_id ).click( function() { 
			  collection.forwards(); 
			  refresh_all(); 
		      } );
		      $( '#' + pag_end_button_id ).click( function() { collection.last(); refresh_all(); } );
		  } else {
		      $( '#' + pag_forward_button_id ).attr( 'disabled', true );
		      $( '#' + pag_end_button_id ).attr( 'disabled', true );
		  }		  
	      }, //init_paginator
	      Delete_Cron_Entry:function( args ) {
		  console.log( [ 'ARGS', args ] );
	      },
	  } );

	  attach_login( {
	      attachpoint         : '#logged_in_status',
	      message_attachpoint : '#msg_div',
	      after_login  : refresh_all,
	      after_logout : refresh_all
	  } );

	  function refresh_all() {
	      if( $.yote.is_root() ) {
		  $( '#errpanel' ).hide();
		  $( '#mainpanel' ).show();
		  root = $.yote.fetch_root();
	      }
	      else {
		  $( '#errpanel' ).show();
		  $( '#mainpanel' ).hide();
		  return;
 	      }
	      $.yote.util.register_template_variable( 'cron', root.cron() );
	      $.yote.util.register_template_variable( 'root', root );

	      $.yote.util.refresh_ui();
	  }//refresh_all
      });
    </script>

<script type="text/template" class="yote_template_definition" template_name="Empty">
   None Found
</script>

<script type="text/template" class="yote_template_definition" template_name="Cron">
 <H3>Crons</H3>
 <$@ Cron_Table Empty _ entries @$>
 <$ newbutton _ entries Add Cron $>
</script>

<script type="text/template" class="yote_template_definition" template_name="Cron_Table">

  <table border=1><tr>  <th>Name</th>     <th>Enabled</th>   <th>Notes</th>  
                        <th>Script</th>   <th>Next Run</th>  <th>Repeat</th>
                        <th>Schedule</th> <th>Delete</th>
                  </tr>
      <@ Cron_Row 2 @> 
    
  </table>
  <$$ Paginator $$>
  <!-- pagination goes here. Under the hood, there must be a context container or a default tag, or even last list -->
</script>

<script type="text/template" class="yote_template_definition" template_name="Cron_Row">
  <tr> <td> <$ edit _ name $> </td>  <td> <$ checkbox _ enabled $> </td>  <td> <$ edit _ notes $> </td>
    <td> <$ edit _ script $> </td>  <td> <? cron_entry_next_time ?> </td>  <td> <$$ Entry_Repeat $$> </td>
    <td> <$$ Entry_Schedule $$> </td>  <td> <$ button Delete_Cron_Entry Delete $> </td> 
  </tr>
</script>

<script type="text/template" class="yote_template_definition" template_name="Paginator">
  <$$$ paginate_to_beginning_button <button type="button">&lt;&lt;</button> $$$>
  <$$$  paginate_back_button <button type="button">&lt;</butotn> $$$>
  <$$$  paginate_forward_button  <button type="Button"> &gt;</button> $$$>
  <$$$  paginate_to_end_button  <button type="Button">&gt;&gt;</button> $$$>
<BR>
Need to register the registered values in a way that can be accessed from anywhere in $.yote.util.  
A template id is stored along with the control. In this way no need for new variables, as anything registered
will be visible during the function call.
<BR>
  <?? init_paginator ??>
</script>

<script type="text/template" class="yote_template_definition" template_name="Entry_Repeat">
 <$@ Entry_Repeat_Table Empty  _ repeats @$>
 Interval (min) : <$$$ repeat_interval new <input type="text"> $$$> <BR>
 Infinite Repeat : <$$$ repeat_infinite new <input type="checkbox"> $$$> <BR>
 Number Repeat Times : <$$$ repeat_times new <input type="text"> $$$> <BR>
 <$ newbutton _ repeats Add Repeat $>
</script>

<script type="text/template" class="yote_template_definition" template_name="Entry_Repeat_Table"> 

  <table border=1><tr>  <th>Interval (mins)</th>     <th>Infinite Repeat</th>   <th>Repeats</th>  
                        <th>Delete</th>
                        <th>Schedule</th> <th>Delete</th>
                  </tr>
      <@ Cron_Repeat_Row 20 @> 
  </table>
  <$$ Paginator $$> 
  <!-- pagination goes here. Under the hood, there must be a context container or a default tag, or even last list -->
</script>

<script type="text/template" class="yote_template_definition" template_name="Cron_Repeat_Row">
  <tr>  <td><$ edit _ repeat_interval $></td>  <td><$ checkbox _ repeat_infinite $></td>  <td><$ edit _ repeat_times $></td>  <td><$ button delete_repeat Delete $></td>
</script>


<script type="text/template" class="yote_template_definition" template_name="Entry_Schedule">
 <$@ Entry_Schedule_Table Empty _ scheduled_times @$> 
 <$$$ new_schedule_time <input type="datetime-local"> $$$>
 <$ button new_schedule Schedule Time $>
</script>

<script type="text/template" class="yote_template_definition" template_name="Entry_Schedule_Table">

  <table border=1><tr>  <th>Scheduled Time</th> <th>Delete</th> </tr>
      <@ Cron_Schedule_Row 2 @>
  </table>
  <$$ Paginator $$>
  <!-- pagination goes here. Under the hood, there must be a context container or a default tag, or even last list -->
</script>

<script type="text/template" class="yote_template_definition" template_name="Cron_Schedule_Row">
  <tr>  <td><$ show $></td> <td><$ button remove_scheduled_time Delete $></td> </tr> 
</script>

<!-- ------------------------------ -->


<script type="text/template" class="yote_template_definition" template_name="Apps">
 <H3>Applications Installed</H3>
 <$% App_Table Empty _ _apps %$>
</script>

<script type="text/template" class="yote_template_definition" template_name="App_Table">
  <table border=1><tr>  <th>Name</th>     <th>Host</th>   <th>Host URL</th>  
                        <th>Number of Users</th>   <th>Email Settings</th>  <th>Reset</th>
                  </tr>
      <% App_Row 2 %>
  </table>
  <$$ Paginator $$>
</script>

<script type="text/template" class="yote_template_definition" template_name="App_Row">
    <tr>   <th><$ hash_key $></th>     <th><$ edit _ host_name $></th>   <th><$ edit _ host_u2rl $></th>  
                        <th><? app_user_count ?></th>   <th><$$ Email_Settings $$></th>  <th><$ button reset_app Reset $></th>
                  </tr>
</script>

<script type="text/template" class="yote_template_definition" template_name="Email_Settings">
    <table>
      <tr> <td><nobr>Email Validation Required</nobr> </td> <td> <$ checkbox _ requires_validation $> </td> </tr>
      <tr> <td><nobr>Validation Email From</nobr> </td> <td> <$ edit _ validation_email_from $> </td> </tr>
      <tr> <td><nobr>Validation Subject Template</nobr> </td> <td> <$ edit _.validation_subject_template text $> </td> </tr>
      <tr> <td><nobr>Validation Message Template</nobr> </td> <td> <$ edit _.validation_message_template text $> </td> </tr>
      <tr> <td><nobr>Validation Link Template</nobr> </td> <td> <$ edit _.validation_link_template text $> </td> </tr>
    </table>
</script>

<!-- ------------------------------ -->

<script type="text/template" class="yote_template_definition" template_name="Users">
 <H3>Users</H3>
 <$% User_Table Empty _ _handles %$>
</script>

<script type="text/template" class="yote_template_definition" template_name="User_Table">
  <table border=1><tr>  <th>Handle</th>     <th>Email</th>   <th>Is Root</th>  
                        <th>Was Validated</th>
                  </tr>
  <% User_Row 1 %>
  </table>
  <$$ Paginator $$>  
</script>

<script type="text/template" class="yote_template_definition" template_name="User_Row">
    <tr>   <th><$ hash_key $></th> <th><$ show _ email $></th>   <th><? root_status ?></th>  
                        <th><? is_validated ?></th> </tr>
</script>
<!-- ------------------------------ -->

  </head>

  <BODY>

    <DIV class="header">
      <A href="/index.html" style="display:block">
	<img height="70px" width="151px" src="yotelogo.png">
      </A>
      <UL id="top_nav" class="nav"></UL>
      <DIV class="login logged_in" id="logged_in_status"></DIV>
      <DIV id="msg_div"></DIV>
    </DIV>

    <DIV id="errpanel" class="err">
      Must be logged in with a root account to view this page.
    </DIV>

    <DIV class="mainpanel" id="mainpanel">
	<SECTION>
	  <DIV class="page-header">
	    <H1>Yote Admin Page (YAP)</H1>
	  </DIV>
	  <P>
	    Welcome to the Yote Admin Page. This page manages
            the users, apps and cron.
	  </P>
	</SECTION>

	<DIV class="appwrapper">

	  <DIV id="user_b_div" class="yote_template" template="Cron" default_variable="cron"></div>

	  <DIV id="user_b_div" class="yote_template" template="Users" default_variable="root"></div>

	  <DIV id="user_b_div" class="yote_template" template="Apps" default_variable="root"></div>

	</DIV>

    </DIV>

    <hr>

    <footer>
    </footer>
  </body>
</html>
