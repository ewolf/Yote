<!DOCTYPE html>
<html>
<!-- Bootstrappy and meta. This page could replace itself -->
  <head>
    <title>Yote Admin</title>
    <script src="/yote/js/jquery-latest.js"></script>
    <script src="/yote/js/jquery.cookie.js"></script>
    <script src="/yote/js/jquery.base64.min.js"></script>
    <script src="/yote/js/json2.js"></script>

    <script src="/js/main.js"></script>
    <script src="/yote/js/yote.js"></script>
    <script src="/yote/js/yote.util.js"></script>
    <link href="/yote.css" rel="stylesheet" type="text/css" media="all" />
    <link href="/css/main.css" rel="stylesheet" type="text/css" media="all" />

    <META NAME="Author" CONTENT="Eric Wolf, coyocanid@gmail.com">

    <STYLE>
      .mainpanel { top:0px; width:900px; display:inline-block; }
      .tabs {
	  position: relative;
	  min-height: 300px; /* This part sucks */
	  clear: both;
	  margin: 25px 0;
      }
      .tab {
	  float: left;
      }
      .tab label {
	  background: #eee;
	  padding: 10px;
	  border: 1px solid #ccc;
	  margin-left: -1px;
	  position: relative;
	  left: 1px;
      }
      .tab [type=radio] {
	  display: none;
      }
      .content {
	  position: absolute;
	  top: 28px;
	  left: 0;
	  background: white;
	  right: 0;
	  bottom: 0;
	  padding: 20px;
	  border: 1px solid #ccc;
      }
      [type=radio]:checked ~ label {
	  background: white;
	  border-bottom: 1px solid white;
	  z-index: 2;
      }
      [type=radio]:checked ~ label ~ .content {
	  z-index: 1;
      }
      .apppanel { margin-left: 150px; }
      .sidenav { float: left; text-align: center; }
      button.sidenav {     background:none!important; cursor:pointer;
     border:none; 
     padding:0!important;
    /*border is optional*/
     border-bottom:1px solid #444; ; }
      ._ct_row { vertical-align: top }
      ._ct_cell { border: 6px rgb(120,226,165) groove }
    </STYLE>

<!--
there is a beauty that we experience as kids that only leaves tiny hints of itself when we are older.
it hides in smells and in the whispered wind.
if we are our experiences then we are both sides of them.

-->

    <script>
      var root;
    $().ready(function(){
	$( '#mainpanel' ).hide();
	$.yote.init();
	root = $.yote.fetch_root();

	var cron = root.cron();

	function register_items() {
            $.yote.util.register_items( {
		root     : root,
		cron     : cron,
		app_cols : [ 'x', //due to hash key..have to find a better solution TODO
			     '*host_name',
			     '*host_url',
			     { render:function(app){ return app.count('_account_roots'); } },
			     { 
				 req_val : $.yote.util.check_edit( 'requires_validation' ),
				 lef     : $.yote.util.col_edit( 'validation_email_from' ),
				 lmt     : $.yote.util.template_edit( 'validation_message_template' ),
				 lst     : $.yote.util.template_edit( 'validation_subject_template' ),
				 lvt     : $.yote.util.template_edit( 'validation_link_template' ),

				 ref     : $.yote.util.col_edit( 'recovery_email_from' ),
				 rst     : $.yote.util.template_edit( 'recovery_subject_template' ),
				 rmt     : $.yote.util.template_edit( 'recovery_message_template' ),
				 rvt     : $.yote.util.template_edit( 'recovery_link_template' ),

				 render:function(app) {
				     var buf = 
					 '<BR><NOBR>Email Validation Required</NOBR>' + this.req_val( app, true ) +
					 '<BR><NOBR>Validation Email From</NOBR>' + this.lef( app, true ) +
					 '<BR><NOBR>Validation Subject Template</NOBR>' + this.lst( app, true ) +
					 '<BR><NOBR>Validation Message Template</NOBR>' + this.lmt( app, true ) +
					 '<BR><NOBR>Validation Link Template</NOBR>' + this.lvt( app, true );

					 '<BR><NOBR>Recovery Email From</NOBR>' + this.ref( app, true ) +
					 '<BR><NOBR>Recovery Subject Template</NOBR>' + this.rst( app, true ) +
					 '<BR><NOBR>Recovery Message Template</NOBR>' + this.rmt( app, true ) +
					 '<BR><NOBR>Recovery Link Template</NOBR>' + this.rvt( app, true );

				     return buf;
				 },
				 after_render:function( app, name ) {
				     this.req_val( app, false );
				     this.lef( app, false );
				     this.ref( app, false );
				     this.lmt( app, false );
				     this.lst( app, false );
				     this.lvt( app, false );
				 }
			     }, 
			     {
				 render:function(app) {
				     return '<button type="button" id="reset_b_' + app.id + '">Reset</button>';
				 },
				 after_render:function(app,name) {
				     $( '#reset_b_' + app.id ).click(function() {
					 if( confirm( "This will remove all user accounts and app data. Are you sure?" ) ) {
					     root.purge_app( name,
							     function() {  },
							     function( err ) { alert( err ); }
							   );
					 }
				     } );
				 }
			     } ], //app_cols
		user_cols : ['x', //due to hash key..have to find a better solution TODO
			     { //email
				 render:function(l,h){
				     var em=l.get('email');
				     return em?em:'n/a';
				 },
				 after_render:function(app){}
			     },
			     { //is root
				 render:function(l,h){
				     if(l.is_master_root()){
					 return 'master root';
				     }
				     return '<input type="checkbox" id="lr_'+l.id+'" '+
					 (l.is_root()*1==1?' checked':'')+'>';
				 },
				 after_render:function(l,h){
				     if(!l.is_master_root()){
					 (function(li) {
					     $('#lr_'+li.id).click(
						 function(){
						     if($('#lr_'+li.id).is(':checked')){
							 root.make_root(li);
						     } else {
							 root.remove_root( li, function(){}, function(err) { alert(err)} );
						     }
						 }
					     );
					 } )( l );
				     }
				 }
			     },
			     {
				 render: function( l ) {
				     return l.is_validated() ? 'Yes' : 'No';
				 }
			     }
			    ], //user_cols
		cron_cols : [ '*name',
			      $.yote.util.check_edit( 'enabled', undefined, undefined, undefined,
						      function(val,item) {
							  cron.update_entry( entry );
							  cron_ct.refresh();
						      } ),
			      '*notes',
			      '*script',
			      {
				  render : function( entry ) {
				      if( entry.get( 'next_time' ) > 0 )
					  return '<nobr>' +  $.yote.util.format_date( new Date( 60 * 1000 * entry.get( 'next_time' ) ), "h:m Y-M-D" ) + '</nobr>';
				      else
					  return "Not Scheduled";
				  },
				  after_render : function( entry ) {
				      $( '#recalc_' + entry.id ).click( function() {
					  cron.update_entry( entry );
				      } );
				  }
			      },
			      {
				  render : function( entry ) {
				      return '<div id="cron_rep_' + entry.id + '"></div><div id="cron_rep_new_' + entry.id + '"></div>';
				      //repeat
				  },
				  after_render : function( entry ) {
				      var rep_ct = $.yote.util.control_table( {
					  attachpoint : '#cron_rep_' + entry.id,
					  show_count : false,
					  plimit : 100,
					  item : entry,
					  container_name : 'repeats',
					  new_button : 'Add',
					  include_remove : true,
					  column_headers : [ 'Interval (mins)', 'Infinite Repeat', 'Repeats' ],
					  columns : [
					      $.yote.util.col_edit( 'repeat_interval', null, function( val, item ) {
						  item.set( 'repeat_interval', val );
						  cron.update_entry( entry );
						  cron_ct.refresh();
					      } ),
					      $.yote.util.check_edit( 'repeat_infinite', undefined, undefined, undefined,
								      function(val,item) {
									  cron.update_entry( entry );
									  cron_ct.refresh();
								      } ),
					      $.yote.util.col_edit( 'repeat_times', null, function( val, item ) {
						  item.set( 'repeat_times', val );
						  cron.update_entry( entry );
						  cron_ct.refresh();
					      } )
					  ],
					  new_attachpoint : '#cron_rep_new_' + entry.id,
					  new_column_titles : [
					      'interval (min)',
					      'infinite repeat',
					      'times'
					  ],
					  new_required_by_function : function( txts ) {
					      return $( txts[ 0 ] ).val().match( /\S/ ) != null && ( $( txts[ 1 ] ).is( ':checked' ) ||
												     $( txts[ 2 ] ).val().match( /\S/ ) != null );
					  },
					  new_columns : [
					      'repeat_interval',
					      {
						  field : 'repeat_infinite',
						  render : function( cid ) {
						      return '<input type="checkbox" id="' + cid + '">';
						  },
						  on_create : function( item, id ) {
						      item.set( 'repeat_infinite', $( '#' + id ).val() );
						  }
					      },
					      'repeat_times'
					  ],
					  after_new_function : function( newitem ) {
					      cron.update_entry( entry );
					      cron_ct.refresh();
					  }
				      } );
				  }
			      },
			      {
				  render : function( entry ) {
				      return '<div id="cron_sched_' + entry.id + '"></div><div id="cron_sched_new_' + entry.id + '"></div>';
				  },
				  after_render : function( entry ) {
				      var ct = $.yote.util.control_table( {
					  attachpoint : '#cron_sched_' + entry.id,
					  show_count : false,
					  plimit : 100,
					  item : entry,
					  container_name : 'scheduled_times',
					  include_remove : true,
					  column_headers : [ 'Scheduled Time' ],
					  columns : [
					      { render : function( txt ) { return $.yote.util.format_date( new Date( 60000 * txt ), "h:m Y-M-D" ) } }
					  ],
					  new_button : 'Add',
					  new_attachpoint : '#cron_sched_new_' + entry.id,
					  new_column_titles : [ 'when' ],
					  remove_function : function( str, idx ) {
					      entry.list_delete( { name : 'scheduled_times', index : idx } );
					      cron.update_entry( entry );
					      cron_ct.refresh();
					  },
					  new_function : function() {
					      return $( '#cron_new_rep_at' ).val();
					  },
					  after_new_function : function( it ) {
					      cron.update_entry( entry );
					      cron_ct.refresh();
					  },
					  new_columns : [
					      {
						  field : 'scheduled_time_' + $.yote.util.next_id(),
						  on_create : function( str, id ) {
						      var do_when = new Date( $( '#' + id ).val() );
						      entry.add_to( { name : 'scheduled_times', items : [ do_when.valueOf()/60000 ] } );
						      cron.update_entry( entry );
						      cron_ct.refresh();
						  },
						  render : function( id ) {
						      return '<input type="datetime-local" id="' + id + '">';
						  }
					      }
					  ]
				      } );
				      //schedule
				  }
			      }
			    ] //cron_cols

	    } );
	} //register_items

	$( 'button.sidenav' ).each( function( idx, domEl ) {
	    $(this).click(function(){
		$( '.apppanel' ).hide();
		$( '#' + $(this).attr('id') + '_div' ).show();
	    });
	} );

	attach_login( {
	    attachpoint         : '#logged_in_status',
	    message_attachpoint : '#msg_div',
	    after_login  : check_perms,
	    after_logout : check_perms
	} );

	$( '.apppanel' ).each( function( idx, domEl ) { $( this ).hide(); } );

	function check_perms() {
	    if( $.yote.is_root() ) {
		$( '#errpanel' ).hide();
		$( '#mainpanel' ).show();
		cron = root.cron();
		register_items();
		$.yote.util.init_ui();
	    }
	    else {
		$( '#errpanel' ).show();
		$( '#mainpanel' ).hide();
 	    }
	}
    });
    </script>
  </head>

  <BODY>

    <DIV class="header">
      <A href="/index.html" style="display:block">
	<img height="70px" width="151px" src="yotelogo.png">
      </A>
      <UL id="top_nav" class="nav"></UL>
      <DIV class="login logged_in" id="logged_in_status"></DIV>
      <DIV id="msg_div"></DIV>
    </DIV>

    <DIV id="errpanel" class="err">
      Must be logged in with a root account to view this page.
    </DIV>

    <DIV class="mainpanel" id="mainpanel">

	<!--
	    accounts, with pagination and search
	    edit motd
            add and edit news
	    show apps
	  -->

	<SECTION>
	  <DIV class="page-header">
	    <H1>Yote Admin Page (YAP)</H1>
	  </DIV>
	  <P>
	    Welcome to the Yote Admin Page. This page manages
            the users, apps and cron.
	  </P>
	</SECTION>

	<DIV class="appwrapper">
	  <DIV id="sidenav" class="sidenav">
            <UL>
	      <LI><BUTTON class="sidenav" disabled id="app_b">Apps</BUTTON></LI>
	      <LI><BUTTON class="sidenav" disabled id="user_b">Users</BUTTON></LI>
	      <LI><BUTTON class="sidenav" disabled id="cron_b">Cron</BUTTON></LI>
            </UL>
	  </DIV>

	  <DIV id="user_b_div" class="control_table apppanel" is_admin="root"
	       plimit="10" item="$root" container_name="_handles"
	       paginate_type="hash" title="Logins"
	       column_headers="['Handle','Email','Is Root','Is Validated']"
	       columns="$user_cols" after_render="*function(){ $('#user_b').prop('disabled',false); }"
	       >
	  </DIV>

	  <DIV id="app_b_div" class="control_table apppanel" is_admin="root"
	       plimit="10" item="$root" container_name="_apps" paginate_type="hash"
	       title="Apps" 
	       column_headers="['Name','Host','Host URL','Number of Users','Email Settings','Reset']"
	       columns="$app_cols" after_render="*function(){ $('#app_b').prop('disabled',false); }"
	       >
	  </DIV>

	  <DIV id="cron_b_div" class="apppanel">
	    <DIV id="cron_entry_div" class="control_table" is_admin="root"
		 plimit="10" item="$cron" container_name="entries"
		 title="Crons" include_remove="true" 
		 column_headers="['Name','Enabled','Notes','Script','Next Run','Repeat','Schedule']"
		 columns="$cron_cols" after_render="*function(){ $('#cron_b').prop('disabled',false); }"
		 control_table_name="cron_ct"
		 >
	    </DIV>

            <DIV id="reset_cron_panel" class="yote_panel" show="return '<BUTTON TYPE=button ID=reset_cron>Reset Cron</BUTTON>';"
                 after_show="$('#reset_cron').click(function(){root.reset_cron()});"
            ></DIV>

	  </DIV>

	  <DIV id="appnewpanel_cron" class="apppanel"></DIV>

	  <DIV id="apppanel_pages" class="apppanel">
	  </DIV>

	</DIV>

    </DIV>

    <footer>
    </footer>
  </body>
</html>
