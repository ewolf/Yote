<html>
  <head>
    <title> Calcy Testy</title>
    <script src="/__/js/yote.js"></script>
    <script src="/__/js/jquery-1.12.0.min.js"></script>
    <script>
      <!--
      function init() {
          yote.initMain();

          function activateUpdateFields() {
              $( 'input.updateField' ).off().on( 'keydown', function(ev) {
                  var kk = ev.keyCode || ev.charCode;
                  if( kk == 13 || kk == 9 ) {
                      var $this = $( this );
                      var obj = yote.fetch( $this.data('id') );
                      var fld = $this.data('field');
                      var inpt = {};
                      inpt[ fld ] = $this.val() ;
                      obj.update( [ inpt ] );
                  }
              } );
              $( 'span.updateField>span' ).off().on( 'click',
                                                     function() {
                                                         var $this = $(this);
                                                         $this.parent().addClass( 'editing' );
                                                         var $inpt = $this.parent().find( 'input' );
                                                         $inpt.data('original', $inpt.val() );
                                                     } );
              $( 'span.updateField>input' ).on( 'keydown',
                                                function(ev) {
                                                    var kk = ev.keyCode || ev.charCode;
                                                    var $this = $(this);
                                                    if( kk == 27 )  {
                                                        $this.val( $this.data( 'original' ) );
                                                        $this.parent().removeClass( 'editing' );
                                                        $this.removeClass('edited' );
                                                    } else if( kk == 13 || kk == 9 ) {
                                                        var p = $this.parent();
                                                        p.removeClass( 'editing' );
                                                        p.find('span').text( $this.val() );
                                                        $this.removeClass('edited' );
                                                    }
                                                    $this.toggleClass('edited', $this.data('original') == $this.val() );
                                                } );
              $( 'span.updateField>input' ).off().on( 'keyup', function() {
                  var $this = $(this);
                  console.log( [$this.data('original'),$this.val(), $this.data('original')!=$this.val()] );
                  $this.toggleClass('edited', $this.data('original') != $this.val() );
              } );

              $( '.delAction' ).off().on( 'click', function(ev) {
                  var $this  = $(this);
                  if( $this.data( 'needs-confirmation' ) && ! confirm( $this.data( 'delete-message' ) || 'really delete?' ) ) {
                      return;
                  }
                  var par    = yote.fetch($this.data( 'parent' ));
                  var obj    = yote.fetch($this.data( 'id' ));
                  par.remove_entry( [obj,$this.data('from')] );
              } );
              $( '.addAction' ).off().on( 'click', function(ev) {
                  var $this = $(this);
                  var create_action = $this.data('action');
                  var list  = $this.data('list');
                  var listOn = yote.fetch( $this.data('id') );
                  yote.callWorker( {
                      callpath : 'addEntry',
                      params   : [ listOn, list ]
                  } );
              } );
          } //activateUpdateFields

          var costForm = new Intl.NumberFormat( "en-US", {
              minimumFractionDigits : 2,
              style : "decimal",
          } );

          function watchObjects() {
              for( var i=0; i<arguments.length; i++ ) {
                  var obj = arguments[ i ];
                  var updater = function(o) {
                      var id = o.id;
                      $( ".showField" ).each( function() {
                          var $this = $(this);
                          if( $this.data('id') != id ) {
                              return;
                          }
                          var fld = $this.data( 'field' );
                          var val = o.get( fld );
                          if( $this.data( 'format' ) == '$' ) {
                              val = costForm.format( val );
                          }
                          if( $this.is( 'input' ) ) {
                              $this.val( val );
                          } else {
                              $this.text( val );
                          }
                      } );
                  }
                  obj.addUpdateListener( updater, 'update' );
                  updater( obj );
              }
          } //watchObjects

          function watchObject( obj, onUpdate, key ) { // when changed, onUpdate is called on that object.
              obj.addUpdateListener( function(o) {
                  onUpdate(o);
              }, key );
          } //watchObject

          var app, curScene, curProd;

          function setup_app(a) {
              app = a;

              // * ) update data-id of things app
              $( '.app' ).each( function() {
                  $(this).data( 'id', app.id );
              } );

              curScene = app.get( 'current_scenario' );

              // set up scenario picker
              var scnz = app.get('scenarios');
              setup_picker( scnz,$('#scenario_sel') );
              

              // * ) set up scenario
              setup_scenario( curScene );

              // * ) set up watchers
              watchObject( scnz, function() { 
                  setup_picker( scnz,$('#scenario_sel') );
                  if( scnz.length() > 1 ) {
                      $( '#del_scenario').show();
                  } else {
                      $( '#del_scenario').hide();
                  }
              } );
              watchObjects(app); //connects todata fields
              watchObject( app, function(app) {
                  if( ! curScene._is( app.get('current_scenario') ) ) {
                      curScene = app.get('current_scenario');
                      setup_scenario( curScene );
                  }
              } );

              // updating the scenario selector changes the current scenario
              $( '#scenario_sel' ).off().on('change',function() {
                  var seld_id = $( "#scenario_sel" ).val();
                  var sel = yote.fetch( seld_id );
                  app.setCurrentScenario( sel, function() {
                      activateUpdateFields();
                  } );
              } );


          } //setup_app

          function setup_picker(scenes,$select) {
              var sceneArr = scenes.toArray();
              $select.empty().append(
                  sceneArr.map( function( sc ) {
                      var seld = curScene._is( sc ) ? ' selected' : '';
                      return '<option value="' + sc.id + '"' + seld + '>' + 
                          sc.get('name') + '</option>';
                  } ).join('')
              );
          }
          
          function setup_scenario(scenario) {
              // * ) update data-id of things scenario
              $( '.scenario' ).each( function() {
                  $(this).data( 'id', scenario.id );
              } );

              var prods = scenario.get( 'product_lines' );

              // * ) setup products table
              var $tab = $( '#product-table' ).empty();

              if( prods.length() > 0 ) {
                  var buf = '<tr>' + [ 'name', 'production rate' ]
                      .map( function(w) { return '<th>' + w + '</th>'; } ).join('') + '</tr>';
              }

              // * ) setup focused product picker
              setup_picker( prods,$('#prod_sel') );

              // * ) setup focused product
              curProd = app.get( 'current_product_line' );
              if( typeof curProd !== 'object' ) { curProd = undefined; }
              setup_product( curProd );

              // * ) set up watchers
              watchObject( prods, function() { 
                  setup_picker( prods,$('#prod_sel') );
              } );
              watchObjects(scenario);
              watchObject( scenario, function() { 
                  if( ! curProd || ! curProd._is( curScene.get('current_product_line') ) ) {
                      curProd = curScene.get('current_product_line');
                      if( typeof curProd !== 'object' ) { curProd = undefined; }
                      setup_product( curProd );
                  }
              } );

              // updating the scenario selector changes the current scenario
              $( "#prod_sel" ).off().on('change',function(scene) {
                  var line_id = $( "#prod_sel" ).val();
                  var line = yote.fetch( line_id );
                  curScene.update( [{ current_product_line : line }] );
              } );
              activateUpdateFields();

          } //setup_scenario

          function setup_product(prd) {
              // * ) update data-id of things product
              // * ) setup_steps_table from list
              // * ) set up update listener on steps list which calls setup_steps_table
              // * ) setup new step button
              // * ) check for edit/showFields that were not initialized
          }

          function setup_steps_table(steps) {
              // * ) empty steps table
              // * ) fill steps table with steps
              // * ) check for edit/showFields that were not initialized
          }

          yote.doSequence( [ //function is passed in take two args, a callback and a fail handler
              yote.initRoot(),
              yote.loadApp( 'CalcTest' ),
              yote.workerLoadInclude( "/__/samp/js/calctest.js" ),
              yote.readyWorkerCall( 'init' ),
//              yote.readyWorkerCall( 'reset' ), //uncomment this to reset everything
              function() {
                  setup_app( yote.fetch_app( 'CalcTest' ) ); 
                  return;
                  // setup_app( yote.fetch_app( 'CalcTest' ) );
                  // tie the calcResult field of the app to an informative hourCost div
                  var app = yote.fetch_app( 'CalcTest' );
                  var currScenario;

                  $( '#del_scenario' ).each( function() {
                      $(this).data( 'parent', app.id );
                  } );
                  $( '.app' ).each( function() {
                      $(this).data( 'id', app.id );
                  } );

                  updateScenarioSelect();
                  selectScenario( app.get( 'current_scenario' ) );


                  
                  function updateScenarioSelect() {
                      // redo select
                      var $sel = $( '#scenario_sel' );
                      $sel.empty();
                      $( '#del_scenario').hide();
                      var scenarios = app.get( 'scenarios' ).toArray();
                      if( scenarios ) {
                          for( var i=0, len=scenarios.length; i<len; i++ ) {
                              var sen = scenarios[i];
                              $sel.append('<option value="' + sen.id + '">' + sen.get('name' ) + '</option>' );
                          }
                          if( scenarios.length > 1 ) {
                              $( '#del_scenario').show();
                          }
                      }
                  } //updateScenarioSelect

                  function selectScenario( scenario ) {
                      $( "#scenario_sel" ).val( scenario.id );
                      $( "#del_scenario" ).data( 'id', scenario.id );
                      currScenario = scenario;

                      yote.callWorker( {
                          callpath : 'select_scenario',
                          params : scenario,
                          callback : function( resp ) {
                              currScenario = scenario;
                              $( '.scenario,#del_scenario' ).each( function() {
                                  $(this).data('id', currScenario.id );
                              } );
                              updateProdLines();
                              $( '#product-title' ).text( "Products for '" + currScenario.get('name') + '"' );
                          }
                      } );
                      return true;
                  } //selectScenario


                  $( "#RESET" ).off().on('click',function() {
                      if( confirm( 'really delete everything?' ) ) {
                          yote.callWorker( {
                              callpath : 'reset',
                              callback : function( resp ) {
                                  updateScenarioSelect();
                                  selectScenario( app.get('current_scenario') );
                              }
                          } );
                      }
                  } );

                  function updateDataFields() {
                      $( '.showField' ).each( function() {
                          var $this = $( this );
                          var oid = $this.data( 'id' );
                          var obj = yote.fetch( oid );
                          var fld = $this.data('field');
                          if( obj ) {
                              if( $this.is( 'input' ) ) {
                                  $this.val( obj.get( fld ) );
                              } else {
                                  $this.text( obj.get( fld ) );
                              }
                          } else {
                              console.warn( ["Unable to update data field", $this ] );
                          }
                      } );
                  } //updateDataFields



                  function updateProdLines() {
                      var lines = currScenario.get( 'product_lines' ).toArray();
                      $('#products').empty();
                      var $table = $( '#product-table' ).empty().append( '<tr> <th> Product </th> <th> Production Rate </th> <th> Production Cost </th> <th> Profit </th> </tr>' );
                      for( var i=0; i<lines.length; i++ ) {
                          var line = lines[i];

                          // build up the table
                          $table.append( '<tr> <td> ' + [ line.get('name'),
                                                          '<span  class="showField" data-id="' + line.id + '" data-field="production_rate">?</span>',
                                                          '<span  class="showField" data-id="' + line.id + '" data-field="production_cost">?</span>',
                                                                                                                    '<span  class="showField" data-id="' + line.id + '" data-field="profit">?</span>',                   
                                                        ].join(' </td><td> ') + '</td></tr>' );

                          // build up the sections below the table

                          var buf = '<div style="border:solid black 1px;margin:4px;padding:5px;"><br>\
 <input placeholder="Product Line Name" class="updateField showField product-line" data-id="' + line.id + '" data-field="name" type="text">\
 <button class="delAction product-line" data-parent="' + currScenario.id + '" data-from="product_lines" data-id="' + line.id + '">Delete</button> \
 <br>\
 <input placeholder="Description" class="updateField showField product-line" data-id="' + line.id + '" data-field="description" type="text"> <BR>\
 Produces <span  class="showField" data-id="' + line.id + '" data-field="production_rate">?</span> units per hour <br>\
 Cost of production <span  class="showField" data-id="' + line.id + '" data-field="production_cost">?</span> dollars per hour <br>\
\
 Units per day <span  class="showField" data-id="' + line.id + '" data-field="produced_in_day">?</span> <br> \
 Units per month <span  class="showField" data-id="' + line.id + '" data-field="produced_in_month">?</span> <br> \
\
 <h5>Process Steps</h5>\
 <button class="addAction product-line" data-list="steps"  data-id="' + line.id + '">Add Step</button>\
 <div style="margin-left:3em;" data-product-line-id="' + line.id + '">';
                          var steps = line.get( 'steps' ).toArray();
                          for( var j=0; j<steps.length; j++ ) {
                              var step = steps[j];

                              // ~~~~~~~~ HERE is here
                              //  ~~~~~~~~~~ how about a table, and include employees required for step, min step time,
                              // ~~~~~~~~ max step time (or max batch size?)
                              
                              buf += '<input class="updateField step showField" \
                                             place-holder="step name" data-id="' + step.id + '" \
                                             data-field="name" type="text"> \
                                      Can produce <input class="updateField showField step" \
                                                  data-id="' + step.id + '" \
                                                  data-field="units_produced" type="text"> \
                                      units per <input class="updateField showField step" \
                                                       data-id="' + step.id + '" data-field="hours" type="text"> \
                                      hour. Rate of <span class="showField" data-id="' + step.id + '" \
                                                         data-field="production_rate"></span>  \
                                      <BR>';
                          }

                          buf += '</div>';
                          $('#products').append( buf );
                      }
                      updateDataFields();
                      activateUpdateFields();
                  } // updateProdLines

                  $( "#scenario_sel" ).off().on('change',function() {
                      var seld_id = $( "#scenario_sel" ).val();
                      var sel = yote.fetch( seld_id );
                      selectScenario( sel );
                   } );



              }
          ] )
              .fail( 1, function() { console.log( "Step 1 failed" ) } )
              .fail( '++*', function() { console.log( "Before any failure do this" ) } )
              .fail( '*++', function() { console.log( "After any failure do this" ) } )
              .fail( '*', function() { console.log( "Do this failure unles the step has a specific error message" ) } )
              .start();
      }
-->
    </script>

    <style>
    span.updateFieldControl { display: inline-block; background-color:lightgrey; }
    span.updateFieldControl:hover { cursor: pointer; background-color:yellow; }
    span.updateFieldControl>input { display: none; }
    span.updateFieldControl>span { display: inline; }
    span.updateFieldControl.editing>input { display: inline; background-color:lightgray; }
    span.updateFieldControl.editing>input.edited { display: inline; background-color:yellow; }
    span.updateFieldControl.editing>span { display: none; }
    </style>

  </head>
  <body onLoad="init()">
    <h1>Shoppe Demo</h1>

    <h3>Scenarios</h3>
    <p>
      Scenarios allow you to do different sorts of speculations and configurations. <a href="" class="addAction app" data-list="scenarios" data-id="">Create New Scenario</a>
    </p>
    Selected Scenario <select class="app" id="scenario_sel"></select>
    
        <a href="" class="delAction app" style="display:none" id="del_scenario" data-needs-confirmation="y" data-delete-message="Really delete this scenario?">Delete this Scenario</a> <BR>
        <div>
          <h3>Configure Scenario</h3>
          <dl>
            <dt>Scenario Name</dt>
            <dd>
              <span class="updateFieldControl">
                    <input class="updateField showField scenario" data-id="ofobj" data-field="name" type="text">
                    <span class="showField scenario" data-id="ofobj" data-field="name"></span>
              </span>
                   </dd>
            <dt>Description</dt>
            <dd><input class="updateField showField scenario" data-id="ofobj" data-field="description" type="text"> </dd>
            <dt>Number of Employees</dt>
            <dd><input class="updateField showField scenario" data-id="ofobj" data-field="employee_count" type="text" size="3" > </dd>
            <dt>Employee Pay</dt>
            <dd><input class="updateField showField scenario" data-id="ofobj" data-format="$" data-field="employee_pay_rate" type="text" size="5"> $/hour </dd>
          </dl>
          $ <span class="showField scenario" data-id="ofobj" data-format="$" data-field="employee_monthly_cost"></span> / month

    <hr>
    <h4 id="product-title">Products</h4>
    <table id="product-table"> 
    </table>
    <hr>
    <h4 id="product-title">Products</h4>

    <select class="scenario" id="prod_sel" data-id="sceneid"></select>

    <button type="button" class="addAction scenario" data-list="product_lines" data-id="sceneid">Create New Product Line</button>
    <div id="curr_product">
      No Products
    </div>
    </div>

  </body>
</html>
