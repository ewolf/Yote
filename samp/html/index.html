<html>
  <head>
    <title> Calcy Testy</title>
    <script src="/__/js/yote.js"></script>
    <script src="/__/js/jquery-1.12.0.min.js"></script>
    <script>
      <!--
      function init() {
          // THIS IS IT, THE WHOLE INIT ENCHILADA
          $( '.template' ).each( function() { $(this).find('*').each(function() { $(this).toggleClass('template', true ); } ) } );
          yote.init( {
              appName : 'CalcTest',
              handler : function( root, app ) {
//                  app.reset();return;
                  app.gather_all( [], function() {
                      setup_app( app );
                  } );
              }
          } );

          function energize( cls, obj ) {
              setIds( cls, obj );
              activateControls();
              watchForUpdates( obj );
          }

          function fill_template( sel, vars, fields ) {
              var $template = $( sel );
              if( $template.length != 1 ) {
                  console.warn( "error filling template '" + sel + "'. selector matches somethign other than one thing." );
                  return undefined;
              }
              $template = $template.clone();
              $template.attr( 'id', $template.attr('id') + '-clone' );
              $template.removeClass('template');
              $template.find("*").each( function() {
                  var $this = $(this);
                  $this.removeClass( 'template' );
                  for( var i=0;i<fields.length; i++ ) {
                      var fld = fields[i];
                      if( vars[$this.data( fld )] ) {
                          $this.data( fld, vars[$this.data( fld )] );
                      }
                  }
              } );
              return $template;
          } //fill_template

          function setIds( cls, obj ) {
              $( '.' + cls + ',.'+cls+'-child' ).each( function() {
                  var $this = $(this);

                  if( $this.is( 'select' ) && $this.data( 'id' ) != obj.id ) {
                      // special casey thing to regenerate select controls
                      $this.removeClass( 'build-select' );
                  }
                  if( $this.hasClass( cls+'-child' ) ) {
                      $this.data( 'parent', obj.id );
                  }
                  if( $this.hasClass( cls ) ) {
                      $this.data( 'id', obj.id );
                  }
              } );
          }

          function updateListener( obj, listenerName, listenerFunc, runOnStartup ) {
              if( ! obj[ listenerName ] ) {
                  obj[ listenerName ] = true;
                  obj.addUpdateListener( listenerFunc );
              }
              if( runOnStartup ) {
                  listenerFunc();
              }
          } //updateListener

          function modifyControl( selector, key, fun ) {
              selector = selector;
              if( typeof key === 'object' ) {
                  for( var k in key ) {
                      modifyControl( selector, k, key[k] );
                  }
                  return;
              }
              key = 'set-' + key + '-listener';
              $( selector ).each( function() {
                  var $this = $( this );
                  if( ! $this.hasClass('template') ) {
                      if( ! $this.data( key ) && $this.data('id') ) {
                          $this.data( key, true );
                          fun( $this );
                      }
                  }
              } );
          }

          function _updateSelect( $sel, list, listIsObj ) {
              var cur_val;
              var list_fld = $sel.data('src-field');

              var obj = yote.fetch( $sel.data('id') );
              if( listIsObj ) {
                  list = list || obj.get( list_fld );
                  valTitles = list.toArray();
              } else {
                  valTitles = list;
              }
              var cur_fld = $sel.data('field');
              if( cur_fld ) {
                  cur_val = obj.get( cur_fld );
                  if( typeof cur_val === 'object' ) {
                      cur_val = cur_val.id;
                  }
              }

              var isObj = $sel.data( 'var-is') === 'object';
              var buf = '';
              for( var i=0; i<valTitles.length; i++ ) {
                  var vt = valTitles[i];
                  var val, title;
                  if( Array.isArray( vt ) ) {
                      val   = vt[0];
                      title = vt[1];
                  } else {
                      val   = vt;
                      title = vt;
                  }
                  if( typeof val === 'object' ) {
                      val = val.id;
                  }
                  if( typeof title === 'object' ) {
                      title = title.get( 'name' );
                  }
                  buf += '<option class="showField" ' + 
                      'data-field="name" ' +
                      ( cur_val === val ? 'selected="true" ' : '' ) + 
                      'data-id="' + val + '" value="' + val + '">' + title + '</option>';
              }
  
              $sel.empty().append( buf );
              $sel.val( cur_val );

              if( cur_fld ) {
                  $sel.off('change').on('change',function() {
                      var $this = $(this);
                      var val = $this.val();
                      var inpt = {};
                      if( isObj ) {
                          val = yote.fetch( val );
                      }
                      inpt[ cur_fld ] = val;
                      var o = yote.fetch( $sel.data('id') );
                      o.update( [ inpt ] );
                  } );
              }
              if( listIsObj ) {
                  updateListener( list, 'select-listener', function() { 
                      _updateSelect($sel,list,listIsObj);
                  }, false );
              }
          } // _updateSelect


          function activateControls()  {
              modifyControl( 'div.updateFieldControl', 'updateField-setup', function( $ctrl ) {
                  $ctrl.empty().append( '<input class="updateField showField ' + $ctrl.data('classes') + '" ' + 
                                        '       data-id="'    + $ctrl.data('id') + '"' + 
                                        '       data-field="' + $ctrl.data( 'field' ) + '"' + 
                                        '       type="'       + $ctrl.data('input-type') + '">' +
                                        '<span class="showField ' + $ctrl.data('classes') + '"' + 
                                        '      data-id="' + $ctrl.data('id') + '"' + 
                                        '      data-field="' + $ctrl.data('field') + '">' + 
                                        '  &nbsp;</span>' );
              } );
              modifyControl( 'div.updateFieldControl>span', 'updateField-click', function( $ctrl ) {
                  $ctrl.on( 'click',
                            function() {
                                var $this = $(this);
                                $this.parent().addClass( 'editing' );
                                var $inpt = $this.parent().find( 'input' );
                                $inpt.data('original', $inpt.val() );
                                $inpt.focus();
                            } );
              } );
              modifyControl( 'div.updateFieldControl', 'updateField-click', function( $ctrl ) {
                  $ctrl.on( 'click',
                            function() {
                                var $this = $(this);
                                $this.addClass( 'editing' );
                                var $inpt = $this.find( 'input' );
                                $inpt.data('original', $inpt.val() );
                                $inpt.focus();
                            } );
              } );
              modifyControl( 'div.updateFieldControl>input', {
                  'updateField-blur' : function( $ctrl ) {
                      $ctrl.on( 'blur',
                                function(ev) {
                                    var $this = $(this);
                                    if( $this.data( 'original' ) == $this.val() ) {
                                        $this.parent().removeClass( 'editing' );
                                    }
                                } );
                  },
                  'updateField-keydown' : function( $ctrl ) {
                      $ctrl.on( 'keydown',
                                function(ev) {
                                    var kk = ev.keyCode || ev.charCode;
                                    var $this = $(this);
                                    if( kk == 27 )  {
                                        $this.val( $this.data( 'original' ) );
                                        $this.parent().removeClass( 'editing' );
                                        $this.removeClass('edited' );
                                    } else if( kk == 13 || kk == 9 ) {
                                        var p = $this.parent();
                                        p.removeClass( 'editing' );
                                        p.find('span').text( $this.val() );
                                        $this.parent().removeClass( 'editing' );
                                        $this.removeClass('edited' );
                                    }
                                    $this.toggleClass('edited', $this.data('original') == $this.val() );
                                } );
                  },
                  'updateField-keyup' : function( $ctrl ) {
                      $ctrl.toggleClass('edited', $ctrl.data('original') != $ctrl.val() );
                  }
              } );
              modifyControl( 'select.editField', 'build-select', function( $ctrl ) {
                  var list_src_fld       = $ctrl.data('src-field');
                  var obj = yote.fetch( $ctrl.data('id') );

                  if( list_src_fld ) {
                      var list = obj.get( list_src_fld );
                      _updateSelect( $ctrl, list, true );
                  } else {
                      var collection_src_fld = $ctrl.data('src-collection');
                      
                      obj.choices( [collection_src_fld], function( valTitles ) {
                          _updateSelect( $ctrl, valTitles, false );
                      } );
                  }
              } );
              modifyControl( 'input.updateField', 'input-keydown', function( $ctl ) {
                  $ctl.on( 'keydown', function(ev) {
                      var kk = ev.keyCode || ev.charCode;
                      if( kk == 13 || kk == 9 ) {
                          var $this = $( this );
                          var obj = yote.fetch( $this.data('id') );
                          var fld = $this.data('field');
                          var inpt = {};
                          inpt[ fld ] = $this.val() ;
                          obj.update( [ inpt ] );
                      } 
                  } );
              } );

              modifyControl( '.delAction', 'delClick', function( $this ) {
                  $this.on( 'click', function(ev) {
                      if( $this.data( 'needs-confirmation' ) && ! confirm( $this.data( 'delete-message' ) || 'really delete?' ) ) {
                          return;
                      }
                      var par    = yote.fetch($this.data( 'parent' ));
                      var obj    = yote.fetch($this.data( 'id' ));
                      par.remove_entry( [obj,$this.data('from')] );
                      ev.preventDefault();
                  } );
              } );
              modifyControl( '.addAction', 'addClick', function( $this ) {
                  $this.on( 'click', function(ev) {
                      var $this = $(this);
                      var create_action = $this.data('action');
                      var list  = $this.data('list');
                      var listOn = yote.fetch( $this.data('id') );
                      listOn.add_entry( [{ listName: list }], function( newo ) { watchForUpdates( Array.isArray( newo ) ? newo[0] : newo ); } );
                      ev.preventDefault();
                  } );
              } );
          } //activateControls


          var _costForm = new Intl.NumberFormat( "en-US", {
              minimumFractionDigits : 2,
              maximumFractionDigits : 2,              
              style : "decimal",
          } );

          var _updater = function(o) {
              var id = o.id;
              $( ".showField" ).each( function() {
                  var $this = $(this);
                  if( $this.data('id') != id ) {
                      return;
                  }
                  var fld = $this.data( 'field' );
                  var val = o.get( fld );

                  if( $this.data( 'format' ) == '$' ) {
                      val = _costForm.format( val );
                  }
                  if( $this.is( 'input' ) ) {
                      $this.val( val );
                  } else if( $this.is( 'select' ) ) {
                      if( typeof val === 'object' ) {
                          $this.val( val.id );
                      } else {
                          $this.val( val );
                      }
                  } else if( val ) {
                      $this.text( val );
                  } else {
                      $this.html( '&nbsp;' );
                  }
              } );
          }              

          function watchForUpdates() {
              // if the object changes, all HTML controls displaying data from that object are updated
              for( var i=0; i<arguments.length; i++ ) {
                  var obj = arguments[ i ];
                  if( ! obj._watched ) {
                      obj.addUpdateListener( _updater );
                      obj._watched = true;
                  }
                  _updater( obj );
              }
          } //watchForUpdates

// ---------------------------------------------------------------------------------------------------- //

          function setup_app(app) {

              // show and hide scenario delete so that it does not show if there are less than 2 scenarios
              var scnz     = app.get('scenarios');
              updateListener( scnz, '_deleteListener', function() {
                  if( scnz.length() > 1 ) {
                      $( '#del_scenario').show();
                  } else {
                      $( '#del_scenario').hide();
                  }
              }, true );

              var curScene = undefined;
              updateListener( app, '_curSceneWatcher', function() {
                  if( ! yote.sameYoteObjects( curScene, app.get( 'current_scenarios' ) ) ) {
                      curScene = app.get( 'current_scenarios' );
                      setup_scenario( curScene );
                  }
              }, true );

              energize( 'app', app );
          } //setup_app

          function setup_scenario(scenario) {
              var prods = scenario.get( 'product_lines' );
              updateListener( prods, '_productCountWatched', function() {
                  prods.addUpdateListener( function() {
                      if( prods.length() > 0 ) {
                          $( '#no_products' ).hide();
                          $( '#curr_products,#del_prod,#prod_sel' ).show();
                      } else {
                          $( '#no_products' ).show();
                          $( '#curr_products,#del_prod,#prod_sel' ).hide();
                      }
                      var $tab = $( '#product-table' ).empty();
                      if( prods.length() > 0 ) {
                          var buf = '<tr>' + [ 'name', 'production rate' ]
                              .map( function(w) { return '<th>' + w + '</th>'; } ).join('') + '</tr>';
                          var prodl = prods.toArray();
                          for( var i=0; i<prodl.length; i++) {
                              var line = prodl[i];
                              buf += '<tr>' + [ 'name', 'production_rate' ]
                                  .map( function(w) { return '<td>' + line.get(w) + '</td>'; } ).join('') + '</tr>';
                          }
                          $tab.append( buf );
                      }
                  } );
              }, true );

              var curProd = undefined;
              updateListener( scenario, '_curProdWatcher', function() {
                  if( ! yote.sameYoteObjects( curProd, scenario.get( 'current_product_lines' ) ) ) {                  
                      curProd = scenario.get( 'current_product_lines' );
                      setup_product( curProd );
                  }
              }, true );

              energize( 'scenario', scenario );
          } //setup_scenario

          function setup_product(prd) {
              if( typeof prd === 'undefined' ) {
                  $( '#curr_products,#del_prod,#prod_sel' ).hide();                  
                  return false;
              }

              setup_ingredients_table( prd );
              $( '#new_ingredient' ).off('change').on( 'change', function() {
                  var $this = $( this );
                  var val = $this.val();
                  if( val ) {
                      var chosen = yote.fetch( $this.val() );
                      if( chosen ) {
                          prd.add_entry( [{ listName : 'ingredients',
                                            itemArgs : chosen }], function( newi ) { 
                                                var o = Array.isArray( newi ) ? newi[0] : newi;
                                                watchForUpdates( o ); } );
                      }
                  }
              } );
              
              var ings = prd.get( 'ingredients' );
              updateListener( ings, '_ingsChange', function() {
                  setup_ingredients_table( prd );
              }, true );
              ings.each( function( ing, i ) {
                  watchForUpdates( ing );
              } );

              energize( 'product', prd );
          } //setup_product

          function setup_ingredients_table( prd ) {
              var $tab = $( '#ingredients_tab' ).find( 'tbody' );
              // * ) empty steps table
              $tab.empty();

              var ings = prd.get( 'ingredients' );
              ings.each( function( ing, i ) {
                  var prod = ing.get( 'product' );
                  var row = fill_template( '#ingredient-row', {
                      PARENTPROD : prd.id,
                      PROD : prod.id,
                      ING  : ing.id
                  }, ['id','parent'] );
                  $tab.append( row );
                  watchForUpdates( prod );
              } );
                                     
              activateControls();

          } //setup_ingredients_table

          function setup_steps_table( prd ) {
              var $tab = $( '#steps_tab' ).find( 'tbody' );
              // * ) empty steps table
              $tab.empty();
              var buf = '';

              
              var steps = prd.get( 'steps' );
              steps.removeUpdateListeners().addUpdateListener( function() {
                  setup_steps_table( prd );
              } );
              var stepl = steps.toArray();
              for( var i=0; i<stepl.length; i++ ) {
                  var step = stepl[ i ];
                  buf += '<tr> ' +
                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="name" data-input-type="text"></div> </td>' +

                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="produced_in_run" data-input-type="number"></div> </td>' +

                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="run_hours" data-input-type="number"></div> </td>' +

                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="employees_required" data-input-type="number"></div> </td>' + 
                  '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="overhead" data-input-type="number"></div> </td> ' +
                      
                  '<td>' +
                      '<a href="" type="button" class="moveAction product-child step" data-direction="up" data-id="' + step.id + '" data-from="steps">move up</a><br>' +
                      '<a href="" type="button" class="moveAction product-child step" data-direction="down" data-id="' + step.id + '" data-from="steps">move down</a><br>' + 
                      '<a href="" class="delAction product-child" data-id="' + step.id + '" data-from="steps">delete</a><br>' +
                  '</td> ' +
                '</tr>';
              }
              $tab.append( buf );
              
              activateControls();

              for( var i=0; i<stepl.length; i++ ) {
                  var step = stepl[ i ];
                  watchForUpdates(step);
              }

          } //setup_steps_table

      } //init
-->
    </script>

    <style>
    div.updateFieldControl { display: inline-block; padding: .2em; border: groove 1px #FEFEFE;  min-width: 3em; }
    div.updateFieldControl:hover  { cursor: pointer; background-color:yellow; }
    div.updateFieldControl>span:hover { cursor: pointer; background-color:yellow; }
    div.updateFieldControl>input { display: none; }
    div.updateFieldControl>span { display: inline; min-width: 3em; }
    div.updateFieldControl.editing>input { display: inline; background-color:#EFF; }
    div.updateFieldControl.editing>input.edited { display: inline; background-color:yellow; }
    div.updateFieldControl.editing>span { display: none; }
    span.showField {  }
    .template { display: none }
    </style>



  </head>
  <body onLoad="init()">
    <h1>Shoppe Demo</h1>

    <h3>Scenarios</h3>
    <p>
      Scenarios allow you to do different sorts of speculations and configurations. <a href="" class="addAction app" data-list="scenarios">Create New Scenario</a>
    </p>
    <p>
      Selected Scenario <select class="showField editField app" data-field="current_scenarios"  data-var-is="object" data-src-field="scenarios"></select>
      <a href="" class="delAction app-child scenario" id="del_scenario" data-needs-confirmation="y" data-from="scenarios" data-delete-message="Really delete this scenario?">(Delete this Scenario)</a>
    </p>
        <div>
          <h3>Configure Scenario '<span class="showField scenario" data-field="name"></span>'</h3>
          <table>
            <tr><th>Scenario Name</th>
            <td>
              <div class="updateFieldControl scenario" data-classes="scenario" data-field="name" data-input-type="text" ></div>
              </td></tr>
            <tr><th>Description</th>
            <td><div class="updateFieldControl scenario" data-classes="scenario" data-field="description" data-input-type="text"></div> </td></tr>
            <tr><th>Number of Employees</th>
            <td><div class="updateFieldControl scenario" data-classes="scenario" data-field="employee_count" data-input-type="number"></div>  </td></tr>
            <tr><th>Employee Pay</th>
            <td>$ <div class="updateFieldControl scenario" data-classes="scenario" data-field="employee_pay_rate" data-input-type="number"></div> hour </td></tr>
            <tr><th>Monthly Rent</th>
            <td>$ <div class="updateFieldControl scenario" data-classes="scenario" data-field="monthly_rent" data-input-type="number"></div> /month </td></tr>            
            <tr><th>Monthly Utilities</th>
            <td>$ <div class="updateFieldControl scenario" data-classes="scenario" data-field="monthly_utilities" data-input-type="number"></div> /month </td></tr>
            <tr><th>Employee Monthly Cost</th><td>$<span class="showField scenario" data-format="$" data-field="employee_monthly_cost"></span> / month</td></tr>
            <tr><th>Monthly Cost</th><td>$<span class="showField scenario" data-format="$" data-field="monthly_cost"></span> / month</td></tr>
          </table>
    <hr>
    <h4 id="product-title">Product Summary</h4>
    <table id="product-table"> 
    </table>
    <hr>
    <h4 id="product-title">Products</h4>

    <select class="showField editField scenario" data-field="current_product_lines" data-var-is="object" data-src-field="product_lines" id="prod_sel"></select>

    <a href="" class="addAction scenario" data-list="product_lines">Create New Product Line</a>
    <a href="" class="delAction scenario-child product" id="del_prod" data-needs-confirmation="y" data-from="product_lines" data-delete-message="Really delete this product?">Delete Product Line</a>
    <span id="no_products">No Products</span>
    <div id="curr_product">
      Name : <div class="updateFieldControl product" data-classes="product" data-field="name" data-input-type="text"></div> <br>
      Notes : <div class="updateFieldControl product" data-classes="product" data-field="notes" data-input-type="text"></div>

    <table>
      <tr> <th>Sale Price / unit</th> <td><div class="updateFieldControl product" data-classes="product" data-field="sale_price" data-input-type="number"></div></td> </tr>
      <tr>
        <th>Expected Sales</th> <td><div class="updateFieldControl product" data-classes="product" data-field="expected_sales" data-input-type="number"></div></td>
        <th>per</th> <td><select class="showField editField product" data-field="expected_sales_per" data-src-collection="expected_sales_per"></select></td>
       </tr>


        <tr> <th>Production Rate </th> <td><div class="showField product" data-format="$" data-field="production_rate"></span></td> </tr>
        <tr> <th>Produced in Day </th> <td><span class="showField product" data-format="$" data-field="produced_in_day"></span></td> </tr>
        <tr> <th>Produced in Month </th> <td><span class="showField product" data-format="$" data-field="produced_in_month"></span></td> </tr>
        <tr><th> </th> <td><div></div></td> </tr>
      </table>
      <h4>Ingredients</h4>
      <table border="1" id="ingredients_tab">
        <thead>
          <tr> <th>Ingredient</th> <th>Amount per Batch</th> <th>Notes</th> <th>Action</th> </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <select class="editField showField product" 
              id="new_ingredient"
              data-src-collection="ingreds"
              ></select> Need to have a refreshing function for this

      <h4>Steps</h4>

      <table border=1 id="steps_tab">
        <thead>
    <tr> <th>Name</th> <th>Items per Batch</th>  <th>Duration of Batch ( hours) </th> <th>Employees Needed</th> <th>Overhead ($)</th> <th>Actions</th> </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <a href="" class="addAction product" data-list="steps">New Step</a>
    </div>
    </div>
    <hr>

    <section class="template">
      <table>
        <tr id="ingredient-row"> 
          <td>
            <span class="showField" data-id="PROD" data-field="name"></span>
          </td>
          <td> <div class="updateFieldControl" data-id="ING" data-field="amount_per_run"></div> </td>
          <td> <div class="updateFieldControl" data-id="ING" data-field="notes"></div> </td>
          <td> <a href="" class="delAction" data-parent="PARENTPROD" data-id="ING" data-from="ingredients">delete</a> </td>
        </tr>
      </table>
    </section>

    </body>
    
</html>
