<html>
  <head>
    <title> Calcy Testy</title>
    <script src="/__/js/yote.js"></script>
    <script src="/__/js/jquery-1.12.0.min.js"></script>
    <script>
      function init() {
          yote.initMain();

          yote.doSequence( [ //function is passed in take two args, a callback and a fail handler
              yote.initRoot(),
              yote.loadApp( 'CalcTest' ),
              yote.workerLoadInclude( "/__/samp/js/calctest.js" ),
              yote.readyWorkerCall( 'init' ),
              function() {
                  // tie the calcResult field of the app to an informative hourCost div
                  var app = yote.fetch_app( 'CalcTest' );
                  $( '#del_scene' ).data( 'parent', app.id );
                  function updateDataFields() {
                      $( '.showField' ).each( function() {
                          var $this = $( this );
                          var oid = $this.data( 'id' );
                          var obj = yote.fetch( oid );
                          var fld = $this.data('field');
                          if( obj ) {
                              if( $this.is( 'input' ) ) {
                                  $this.val( obj.get( fld ) );
                              } else {
                                  $this.text( obj.get( fld ) );
                              }
                          } else {
                              console.warn( ["Unable to update data field", $this ] );
                          }
                      } );
                  } //updateDataFields
                  
                  function activateUpdateFields() {
                      $( '.updateField' ).on( 'keypress', function(ev) {
                          if( ev.keyCode == 13 || ev.charCode == 13 ) {
                              var $this = $( this );
                              var obj = yote.fetch( $this.data('id') );
                              var fld = $this.data('field');
                              var inpt = {};
                              inpt[ fld ] = $this.val() ;

                              obj.update( [ inpt ], function() {
                                  updateScenes();
                                  selectScene( currScene );
                              } );
                          }
                      } );
                      $( '.delAction' ).on( 'click', function(ev) {
                          var $this  = $(this);
                          var par    = yote.fetch($this.data( 'parent' ));
                          var obj    = yote.fetch($this.data( 'id' ));
                          var action = $this.data('del-action');
                          par[action]( [obj], function() {
                              selectScene( currScene );
                          } );
                      } );
                      $( '.addAction' ).on( 'click', function(ev) {
                          var $this = $(this);
                          var create_action = $this.data('action');
                          var parent = yote.fetch( $this.data('parent') );
                          var newstep = parent[ create_action ]( [], function() {
                              selectScene( currScene );
                          } );
                      } );
                  } //activateUpdateFields

                  function updateScenes() {
                      // redo select
                      var $sel = $( '#scenario_sel' );
                      $sel.empty();
                      $( '#del_scene').hide();
                      var scenes = app.get( 'scenarios' ).toArray();
                      if( scenes ) {
                          for( var i=0, len=scenes.length; i<len; i++ ) {
                              var sen = scenes[i];
                              $sel.append('<option value="' + sen.id + '">' + sen.get('name' ) + '</option>' );
                          }
                          if( scenes.length > 1 ) {
                              $( '#del_scene').show();
                          }
                      }
                  }

                  function updateProdLines() {
                      var lines = currScene.get( 'product_lines' ).toArray();
                      $('#products').empty();
                      for( var i=0; i<lines.length; i++ ) {
                          var line = lines[i];
                          var buf = '<div><br>\
 <input class="updateField showField product-line" data-id="' + line.id + '" data-field="name" type="text">\
 <button class="delAction product-line" data-parent="' + currScene.id + '" data-id="' + line.id + '" data-del-action="drop_line">Delete</button> \
 <br>\
 Desc <input class="updateField showField product-line" data-id="' + line.id + '" data-field="description" type="text">\
 <span  class="showField" data-id="' + line.id + '" data-field="production_rate"></span> units per hour\
 <h5>Process Steps</h5>\
 <button class="addAction product-line" data-action="new_step" data-parent="' + line.id + '">Add Step</button>\
 <div style="margin-left:3em;" data-product-line-id="' + line.id + '">';
                          var steps = line.get( 'steps' ).toArray();
                          alert( steps.length );
                          for( var j=0; j<steps.length; j++ ) {
                              var step = steps[j];
                              alert( step );
                              buf += 'In <input class="updateField showField step" data-id="' + step.id + '" data-field="hours" type="text"> hours, this produces <input class="updateField showField step" data-id="' + step.id + '" data-field="units_produced" type="text"> units for a rate of <span class="showField" data-id="' + step.id + '" data-field="production_rate"></span> units produced per hour';
                          }

                          buf += '</div>';
                          $('#products').append( buf );
                      }
                      updateDataFields();
                      activateUpdateFields();
                  } // updateProdLines

                  function selectScene( scene ) {
                      $( "#scenario_sel" ).val( scene.id );
                      $( "#scenario_sel" ).val( scene.id );
                      $( "#del_scene" ).data( 'id', scene.id );
                      yote.callWorker( {
                          callpath : 'select_scene',
                          params : scene,
                          callback : function( resp ) {
                              currScene = scene;
                              $( '.scenario' ).each( function() {
                                  var $this = $( this );
                                  $this.data( 'id', currScene.id );
                              } );
                              updateProdLines();
                              $( '#product-title' ).text( "Products for '" + currScene.get('name') + '"' );
                          }
                      } );
                      

                  }

                  $( "#scenario_sel" ).on('click',function() {
                      var seld_id = $( "#scenario_sel" ).val();
                      var sel = yote.fetch( seld_id );
                      selectScene( sel );
                   } );

                  $( "#del_scene" ).on('click',function() {
                      if( confirm( "Really delete scene " + currScene.get('name') ) ) {
                          app.drop_scene( [currScene], function() {
                              updateScenes();
                              selectScene( app.get( 'current_scene' ) );
                          } );
                      }
                  } );


                  $( "#new_product" ).on('click',function() {
                      yote.callWorker( {
                          callpath : 'new_product_line',
                          callback : function(newline) {
                              updateProdLines();
                          }
                      } );
                  } )

                  $( "#new_scene" ).on('click',function() {
                      yote.callWorker( {
                          callpath : 'new_scene',
                          callback : function( news ) {
                              updateScenes();
                              selectScene( news );
                          }
                      } );
                  } )

                  $( "#RESET" ).on('click',function() {
                      if( confirm( 'really delete everything?' ) ) {
                          yote.callWorker( {
                              callpath : 'reset',
                              callback : function( resp ) {
                                  updateScenes();
                                  selectScene( app.get('scenarios').get(0) );
                              }
                          } );
                      }
                  } );

                  // OLD vvvvvvvvvv--------------------
                  $( "#calc" ).on('click',function() {
                      yote.callWorker( {
                          callpath : 'calc',
                          params    : {
                              number_employees : $( '#numEmpl' ).val(),
                              hourly_wage      : $( '#wage' ).val()
                          },
                          callback : function( response ) {
                              // this response has the result of the calculation state
                              // is stored in the response object's calcResult field
                              $( "#hourCost" ).text( response.get( 'calcResult' ) );
                          }
                      } );
                  } );
                  app.addUpdateListener( function( appo ) {
                      $( '#hourCost' ).val( appo.get('calcResult') );
                  } );

                  // OLD ^^^^^^^^^^^^^--------------------

                  updateScenes();
                  var sels = app.get( 'scenarios' ).toArray();
                  var currScene = app.get('current_scene' );
                  selectScene( currScene );



              }
          ] )
              .fail( 1, function() { console.log( "Step 1 failed" ) } )
              .fail( '++*', function() { console.log( "Before any failure do this" ) } )
              .fail( '*++', function() { console.log( "After any failure do this" ) } )
              .fail( '*', function() { console.log( "Do this failure unles the step has a specific error message" ) } )
              .start();
      }
    </script>

  </head>
  <body onLoad="init()">
    <h1>Production Line Scenario Manager</h1>

    <button type="button" id="RESET">RESET</button>
    <hr>
    Available Scenarios <select id="scenario_sel"></select>
    <button type="button" id="new_scene">Create New Scenario</button>
        <button type="button" class="delAction scenario" style="display:none" data-id="" data-parent="" data-del-action="drop_scene" id="del_scene">Delete Scenario</button> <BR>
<div>
    Scenario Name <input class="updateField showField scenario" data-id="ofobj" data-field="name" type="text"> <br>
    Description <input class="updateField showField scenario" data-id="ofobj" data-field="description" type="text"> <br>
    <hr>
    <h4 id="product-title">Products</h4>
    <button type="button" id="new_product">Create New Product Line</button>
    <div id="products">
      No Products
    </div>
</div>
<hr>
    <br> (test area ) <br>
    Number of Employees <input type="number" id="numEmpl"><br>
    Hourly Wage <input type="number" id="wage"> <br>

    <div style="border:1px solid black; display:inline-block">
       <div id="hourCost"></div>
    </div>

    <button type="button" id="calc">Calc</button> <br>

  </body>
</html>
