<html>
  <head>
    <title> Calcy Testy</title>
    <script src="/__/js/yote.js"></script>
    <script src="/__/js/jquery-1.12.0.min.js"></script>
    <script>
      <!--
      function init() {
          // THIS IS IT, THE WHOLE INIT ENCHILADA
          yote.init( {
              appName : 'CalcTest',
              handler : function( root, app ) {
                  app.reset();return;
                  app.gather_all( [], function() {
                      setup_app( app );
                  } );
              }
          } );

          function updateFieldControls(fieldClass) {
              $( 'div.updateFieldControl' + (fieldClass ? '.' + fieldClass : '' )  ).each( function() {
                  var $this = $(this);
                  $this.empty().append( '<input class="updateField showField ' + $this.data('classes') + '" data-id="' + $this.data('id') + '" data-field="' + $this.data( 'field' ) + '" type="' + $this.data('input-type') + '">' +
                                    '<span class="showField ' + $this.data('classes') + '" data-id="' + $this.data('id') + '" data-field="' + $this.data('field') + '">&nbsp;</span>' );
              } );
          }

          function activateUpdateFields() {
              $( 'input.updateField' ).off('keydown').on( 'keydown', function(ev) {
                  var kk = ev.keyCode || ev.charCode;
                  if( kk == 13 || kk == 9 ) {
                      var $this = $( this );
                      var obj = yote.fetch( $this.data('id') );
                      var fld = $this.data('field');
                      var inpt = {};
                      inpt[ fld ] = $this.val() ;
                      obj.update( [ inpt ] );
                  } 
              } );
              $( 'div.updateFieldControl>span' ).off('click').on( 'click',
                                                     function() {
                                                         var $this = $(this);
                                                         $this.parent().addClass( 'editing' );
                                                         var $inpt = $this.parent().find( 'input' );
                                                         $inpt.data('original', $inpt.val() );
                                                         $inpt.focus();
                                                     } );
              $( 'div.updateFieldControl>input' ).off('blur').on( 'blur',
                                                       function(ev) {
                                                           var $this = $(this);
                                                           if( $this.data( 'original' ) == $this.val() ) {
                                                               $this.parent().removeClass( 'editing' );
                                                           }
                                                       } );
              $( 'div.updateFieldControl>input' ).on( 'keydown',
                                                function(ev) {
                                                    var kk = ev.keyCode || ev.charCode;
                                                    var $this = $(this);
                                                    if( kk == 27 )  {
                                                        $this.val( $this.data( 'original' ) );
                                                        $this.parent().removeClass( 'editing' );
                                                        $this.removeClass('edited' );
                                                    } else if( kk == 13 || kk == 9 ) {
                                                        var p = $this.parent();
                                                        p.removeClass( 'editing' );
                                                        p.find('span').text( $this.val() );
                                                        $this.removeClass('edited' );
                                                    }
                                                    $this.toggleClass('edited', $this.data('original') == $this.val() );
                                                } );
              $( 'div.updateFieldControl>input' ).on( 'keyup', function() {
                  var $this = $(this);
                  $this.toggleClass('edited', $this.data('original') != $this.val() );
              } );

              $( '.delAction' ).off('click').on( 'click', function(ev) {
                  var $this  = $(this);
                  if( $this.data( 'needs-confirmation' ) && ! confirm( $this.data( 'delete-message' ) || 'really delete?' ) ) {
                      return;
                  }
                  var par    = yote.fetch($this.data( 'parent' ));
                  var obj    = yote.fetch($this.data( 'id' ));
                  par.remove_entry( [obj,$this.data('from')] );
                  ev.preventDefault();
              } );
              $( '.addAction' ).off('click').on( 'click', function(ev) {
                  var $this = $(this);
                  var create_action = $this.data('action');
                  var list  = $this.data('list');
                  var listOn = yote.fetch( $this.data('id') );
                  listOn.add_entry( { listName: list },
                                    function( item ) {
                      item.gather_all( [], function() {
                          listOn.select_current( [ list, item ] ) } );
                  } );
                  ev.preventDefault();
              } );
          } //activateUpdateFields

          var costForm = new Intl.NumberFormat( "en-US", {
              minimumFractionDigits : 2,
              maximumFractionDigits : 2,              
              style : "decimal",
          } );

          var updater = function(o) {
              var id = o.id;
              $( ".showField" ).each( function() {
                  var $this = $(this);
                  if( $this.data('id') != id ) {
                      return;
                  }
                  var fld = $this.data( 'field' );
                  var val = o.get( fld );
                  if( $this.data( 'format' ) == '$' ) {
                      val = costForm.format( val );
                  }
                  if( $this.is( 'input' ) ) {
                      $this.val( val );
                  } else {
                      $this.text( val );
                  }
              } );
          }              

          function watchObjects() {
              // if the object changes, all HTML controls displaying data from that object are updated
              for( var i=0; i<arguments.length; i++ ) {
                  var obj = arguments[ i ];
                  if( ! obj._watched ) {
                      obj.addUpdateListener( updater );
                      obj._watched = true;
                  }
                  updater( obj );
              }
          } //watchObjects

          function setup_app(app) {

              // * ) update data-id of things app
              $( '.app' ).each( function() {
                  $(this).data( 'id', app.id );
              } );
              updateFieldControls( 'app' );

              var curScene = app.get( 'current_scenarios' );

              // set up scenario picker
              var scnz = app.get('scenarios');
              setup_picker( app, 'scenarios',$('#scenario_sel'), app.setCurrentScenario );
              
              if( scnz.length() > 1 ) {
                  $( '#del_scenario').show();
              } else {
                  $( '#del_scenario').hide();
              }

              // * ) set up scenario
              setup_scenario( curScene );

              // * ) set up watchers. if something is added or removed from the list, this will update
              // the list
              if( ! scnz._listwatched ) {
                  scnz._listwatched = true;
                  scnz.addUpdateListener( function() { 
                      setup_picker( app, 'scenarios', $('#scenario_sel'), app.setCurrentScenario );
                      if( scnz.length() > 1 ) {
                          $( '#del_scenario').show();
                      } else {
                          $( '#del_scenario').hide();
                      }
                  } );
              }

              // watch for changes in the currently selected scenario in the app. If it changes
              // then set the curApp variable and set up the scenario it involves
              if( ! app._curr_watched ) {
                  app._curr_watched = true;
                  app.addUpdateListener( function(app) {
                      // chained ands to create one 'tick'
                      ( ! yote.sameYoteObjects( curScene, app.get('current_scenarios') ) ) && ( curScene = app.get('current_scenarios') ) && setup_scenario( curScene ) && $( '#scenario_sel' ).val( curScene.id );
                  } );
              }
              $( '.app-child' ).each( function() {
                  $(this).data( 'parent', app.id );
              } );

              activateUpdateFields();
              watchObjects(app); //connects todata fields

          } //setup_app

          function update_picker_name(obj,$select) {
              $select.find( 'option[value='+obj.id+']' ).text( obj.get('name') );
          }
          
          function update_picker(obj,listName,$select) {
              var items = obj.get( listName );
              var list = items.toArray();
              var curr = obj.get( 'current_' + listName );
              $select.empty().append(
                  list.map( function( item ) {
                      
                      var seld = yote.sameYoteObjects( curr, item ) ? ' selected' : '';
                      return '<option value="' + item.id + '"' + seld + '>' + 
                          item.get('name') + '</option>';
                  } ).join('')
              );
          }
          
          function setup_picker(obj,listName,$select,onChange) {
              update_picker(obj,listName,$select);
              var items = obj.get( listName );
              var list = items.toArray();
              var curr = obj.get( 'current_' + listName );
              $select.empty().append(
                  list.map( function( item ) {
                      var seld = yote.sameYoteObjects( curr, item ) ? ' selected' : '';
                      return '<option value="' + item.id + '"' + seld + '>' + 
                          item.get('name') + '</option>';
                  } ).join('')
              );

              $select.off('change').on('change',function() {
                  obj.select_current( [listName, yote.fetch( $select.val() )], function(o) {
                      onChange && onChange( o );
                  } );
              } );
          } //setup_picker
          
          function setup_scenario(scenario) {
              // * ) update data-id of things scenario
              $( '.scenario' ).each( function() {
                  $(this).data( 'id', scenario.id );
              } );
              $( '.scenario-child' ).each( function() {
                  $(this).data( 'parent', scenario.id );
              } );
              updateFieldControls( 'scenario' );

              var prods = scenario.get( 'product_lines' );

              // * ) setup products table
              var $tab = $( '#product-table' ).empty();
              if( prods.length() > 0 ) {
                  var buf = '<tr>' + [ 'name', 'production rate' ]
                      .map( function(w) { return '<th>' + w + '</th>'; } ).join('') + '</tr>';
                  var prodl = prods.toArray();
                  for( var i=0; i<prodl.length; i++) {
                      var line = prodl[i];
                      buf += '<tr>' + [ 'name', 'production rate' ]
                          .map( function(w) { return '<td>' + line.get(w) + '</td>'; } ).join('') + '</tr>';
                  }
                  $tab.append( buf );
                  $( '#no_products' ).hide();
                  $( '#curr_products,#del_prod,#prod_sel' ).show();
                  setup_picker( scenario,'product_lines',$('#prod_sel'), setup_product );
              } else {
                  $( '#no_products' ).show();
                  $( '#curr_products,#del_prod,#prod_sel' ).hide();
              }


              // * ) setup focused product
              curProd = scenario.get( 'current_product_lines' );

              if( curProd ) {
                  setup_product( curProd );
                  // * ) setup focused product picker
              }

              // * ) If anything is added to or removed from the list of product lines of the current scene
              if( ! prods._listwatched ) {
                  prods._listwatched = true;
                  prods.addUpdateListener( function() {
                      if( prods.length() > 0 ) {
                          $( '#no_products' ).hide();
                          $( '#curr_products,#del_prod,#prod_sel' ).show();
                          setup_picker( scenario, 'product_lines' ,$('#prod_sel'), setup_product );
                      } else {
                          $( '#no_products' ).show();
                          $( '#curr_products,#del_prod,#prod_sel' ).hide();
                      }
                  } );
              }

              // if the scenario has changed, the scenario name might have changed
              // or the current product may have changed to update both
              if( ! scenario._curr_watched ) {
                  scenario._curr_watched = true;
                  scenario.addUpdateListener( function() {
                      // chained ands to create one 'tick'
                      ( ! yote.sameYoteObjects( curProd, scenario.get('current_product_lines') ) ) && ( curProd = scenario.get('current_product_lines') ) && setup_product( curProd ) && $( '#prod_sel' ).val( curProd.id );
                      update_picker_name( scenario, $('#scenario_sel') );
                  } );
              }
              activateUpdateFields();
              watchObjects(scenario);
              return true;
          } //setup_scenario

          function setup_product(prd) {
              if( typeof prd === 'undefined' ) {
                  $( '#curr_products,#del_prod,#prod_sel' ).hide();                  
                  return false;
              }
              var scenario = prd.get('parent');
              // * ) update data-id of things product
              $( '.product' ).each( function() {
                  $(this).data( 'id', prd.id );
              } );
              updateFieldControls( 'product' );

              // ingredients are other products that are used to make this one
              setup_ingredients_table( prd );
              
              // * ) setup_steps_table from list
              // * ) set up update listener on steps list which calls setup_steps_table
              // * ) setup new step button
              // * ) check for edit/showFields that were not initialized
              setup_steps_table( prd );

              if( ! prd._listwatched ) {
                  prd._listwatched = true;
                  prd.addUpdateListener( function() {
                      setup_picker( scenario, 'product_lines' ,$('#prod_sel'), setup_product );

                      if( ! yote.sameYoteObjects( curProd, scenario.get('current_product_lines') ) ) {
                          curProd = scenario.get('current_product_lines');
                          if( curProd ) {
                              setup_product( curProd );
                          }
                      }
                  } );
              }

              $( '.product-child' ).each( function() {
                  $(this).data( 'parent', prd.id );
              } );

              activateUpdateFields();
              watchObjects(prd);

              return true;
          } //setup_product

          function setup_ingredients_table( prd ) {
              var $tab = $( '#ingredients_tab' ).find( 'tbody' );
              // * ) empty steps table
              $tab.empty();
              var buf = '';

              var ings = prd.get( 'ingredients' );
              ings.removeUpdateListeners().addUpdateListener( function() {
                  setup_ingredients_table( prd );
              } );
              var ingsl = ings.toArray();
              for( var i=0; i<ingsl.length; i++ ) {
                  var ing = ingsl[ i ];
                  var prod = ing.get( 'product_line' );
                  buf += '<tr>  ' +
                      '<td><span class="showField" data-id="' + prod.id + '" data-field="name"></span> </td>' +
                      '<td><span class="showField" data-id="' + ing.id + '" data-field="amount_per_run"></span> </td>' +
                      '<td><span class="showField" data-id="' + ing.id + '" data-field="notes"></span> </td>' +
                      '<td><a href="" class="delAction product-child" data-id="' + ing.id + '" data-from="ingredients"></a> </td>' +
                      '</tr>';
              }              

              buf += '<tr> <td colspan="3"> <select class="product" id="new_ingredient">' +
                  '<option val="-">Choose Ingredient</option>';

              var scenario = prd.get('parent');
              var prodsl = scenario.get( 'product_lines' ).toArray();
              for( var i=0; i<prodsl.length; i++ ) {
                  var prod = prodsl[i];
                  // do not include itself
                  if( ! yote.sameYoteObjects( prod, prd ) ) {
                      buf += '<option val="' + prod.id + '">' + prod.get('name') + '</option>';
                  }
              }
              buf += '</select>' +
                  '</td></tr>';

              $tab.append( buf );

              for( var i=0; i<ingsl.length; i++ ) {
                  var ing = ingsl[ i ];
                  watchObjects( ing );
              }

              $( '#new_ingredient' ).on( 'change', function() {
                  var $this = $( this );
                  var chosen = yote.fetch( $this.val() );
                  prd.add_entry( { listName : 'ingredients',
                                   itemArgs : chosen } );
              } );
              
              return true;

          } //setup_ingredients_table

          function setup_steps_table( prd ) {
              var $tab = $( '#steps_tab' ).find( 'tbody' );
              // * ) empty steps table
              $tab.empty();
              var buf = '';

              
              var steps = prd.get( 'steps' );
              steps.removeUpdateListeners().addUpdateListener( function() {
                  setup_steps_table( prd );
              } );
              var stepl = steps.toArray();
              for( var i=0; i<stepl.length; i++ ) {
                  var step = stepl[ i ];
                  buf += '<tr> ' +
                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="name" data-input-type="text"></div> </td>' +

                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="produced_in_run" data-input-type="number"></div> </td>' +

                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="run_hours" data-input-type="number"></div> </td>' +

                      '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="employees_required" data-input-type="number"></div> </td>' + 
                  '<td><div class="updateFieldControl step" data-classes="step" data-id="' + step.id + '" data-field="overhead" data-input-type="number"></div> </td> ' +
                      
                  '<td>' +
                      '<a href="" type="button" class="moveAction product-child step" data-direction="up" data-id="' + step.id + '" data-from="steps">move up</a><br>' +
                      '<a href="" type="button" class="moveAction product-child step" data-direction="down" data-id="' + step.id + '" data-from="steps">move down</a><br>' + 
                      '<a href="" class="delAction product-child" data-id="' + step.id + '" data-from="steps">delete</a><br>' +
                  '</td> ' +
                '</tr>';
              }
              $tab.append( buf );
              
              updateFieldControls( 'step' );
              activateUpdateFields();

              for( var i=0; i<stepl.length; i++ ) {
                  var step = stepl[ i ];
                  watchObjects(step);
              }

              return true;
          } //setup_steps_table

      } //init
-->
    </script>

    <style>
    div.updateFieldControl { display: inline-block; padding: .2em; border: groove 1px #FEFEFE; }
    div.updateFieldControl:hover  { cursor: pointer; background-color:yellow; }
    div.updateFieldControl>span:hover { cursor: pointer; background-color:yellow; }
    div.updateFieldControl>input { display: none; }
    div.updateFieldControl>span { display: inline; }
    div.updateFieldControl.editing>input { display: inline; background-color:#EFF; }
    div.updateFieldControl.editing>input.edited { display: inline; background-color:yellow; }
    div.updateFieldControl.editing>span { display: none; }
    span.showField {  }
    </style>

  </head>
  <body onLoad="init()">
    <h1>Shoppe Demo</h1>

    <h3>Scenarios</h3>
    <p>
      Scenarios allow you to do different sorts of speculations and configurations. <a href="" class="addAction app" data-list="scenarios" data-id="">Create New Scenario</a>
    </p>
    <p>
      Selected Scenario <select class="app" id="scenario_sel"></select>
      <a href="" class="delAction app-child scenario" id="del_scenario" data-needs-confirmation="y" data-from="scenarios" data-delete-message="Really delete this scenario?">(Delete this Scenario)</a>
    </p>
        <div>
          <h3>Configure Scenario '<span class="showField scenario" data-field="name"></span>'</h3>
          <table>
            <tr><th>Scenario Name</th>
            <td>
              <div class="updateFieldControl scenario" data-classes="scenario" data-field="name" data-input-type="text" ></div>
              </td></tr>
            <tr><th>Description</th>
            <td><div class="updateFieldControl scenario" data-classes="scenario" data-field="description" data-input-type="text"></div> </td></tr>
            <tr><th>Number of Employees</th>
            <td><div class="updateFieldControl scenario" data-classes="scenario" data-field="employee_count" data-input-type="number"></div>  </td></tr>
            <tr><th>Employee Pay</th>
            <td>$ <input class="updateField showField scenario" data-format="$" data-field="employee_pay_rate" type="text" size="5"> hour </td></tr>
            <tr><th>Monthly Rent</th>
            <td>$ <input class="updateField showField scenario" data-format="$" data-field="monthly_rent" type="text" size="5"> /month </td></tr>            
            <tr><th>Monthly Utilities</th>
            <td>$ <input class="updateField showField scenario" data-format="$" data-field="monthly_utilities" type="text" size="5"> /month </td></tr>            
            <tr><th>Employee Monthly Cost</th><td>$<span class="showField scenario" data-format="$" data-field="employee_monthly_cost"></span> / month</td></tr>
            <tr><th>Monthly Cost</th><td>$<span class="showField scenario" data-format="$" data-field="monthly_cost"></span> / month</td></tr>
          </table>
    <hr>
    <h4 id="product-title">Product Summary</h4>
    <table id="product-table"> 
    </table>
    <hr>
    <h4 id="product-title">Products</h4>

    <select class="scenario" id="prod_sel" ></select>

    <a href="" class="addAction scenario" data-list="product_lines">Create New Product Line</a>
    <a href="" class="delAction scenario-child product" id="del_prod" data-needs-confirmation="y" data-from="product_lines" data-delete-message="Really delete this product?">Delete Product Line</a>
    <span id="no_products">No Products</span>
    <div id="curr_product">
      Name : <div class="updateFieldControl product" data-classes="product" data-field="name" data-input-type="text"></div> <br>
      Notes : <div class="updateFieldControl product" data-classes="product" data-field="notes" data-input-type="text"></div>

      <table>
        <tr> <th>Production Rate </th> <td><span class="showField product" data-format="$" data-field="production_rate"></span></td> </tr>
        <tr> <th>Produced in Day </th> <td><span class="showField product" data-format="$" data-field="produced_in_day"></span></td> </tr>
        <tr> <th>Produced in Month </th> <td><span class="showField product" data-format="$" data-field="produced_in_month"></span></td> </tr>
        <tr><th> </th> <td><div></div></td> </tr>
      </table>
      <h4>Ingredients</h4>
      <table border="1" id="ingredients_tab">
        <thead>
          <tr> <th>Ingredient</th> <th>Amount per Batch</th> <th>Notes</th> <th>Action</th> </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

    
      <h4>Steps</h4>

      <table border=1 id="steps_tab">
        <thead>
          <tr> <th>Name</th> <th>Items per Batch</th>  <th>Duration of Batch ( hours) </th> <th>Employees Needed</th> <th>Overhead</th> <th>Actions</th> </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <a href="" class="addAction product" data-list="steps">New Step</a>
    </div>
    </div>
    <hr>
  </body>
</html>
