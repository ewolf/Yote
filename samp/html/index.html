<html>
  <head>
    <title> Calcy Testy</title>
    <script src="/__/js/yote.js"></script>
    <script src="js/calctest.js"></script>

    <script>
      function init() {
          yote.initMain();

          yote.doSequence( [ //functionis passed in take two args, a callback and a fail handler
              yote.initRoot(),
              yote.loadApp( 'CalcTest' ),
              yote.workerLoadInclude( "/__/samp/js/calctest.js" ),
              yote.readyWorkerCall( 'init' ),
              function() {
                  // tie the calcResult field of the app to an informative hourCost div
                  var app = yote.fetch_app( 'CalcTest' );
                  
                  app.addUpdateListener( function( appo ) {
                      document.getElementById( 'hourCost' ).value = appo.get('calcResult');
                  } );

                  function updateScenes() {
                      // redo select
                      var sel = document.getElementById( 'scenario_sel' );
                      while( sel.options.length > 0 ) {
                          sel.remove( 0 );
                      }
                      var scenes = app.get( 'scenarios' ).toArray();
                      if( scenes ) {
                          for( var i=0, len=scenes.length; i<len; i++ ) {
                              var sen = scenes[i];
                              sel.options[sel.options.length] = new Option( sen.get('name'), sel.options.length );
                          }
                      }
                  }

                  function selectScene( scene, idx ) {
                      document.getElementById( "sceneName" ).value = scene.get('name');
                      document.getElementById( "scenario_sel" ).value = idx;
                      app.setCurrentSceneIdx( [idx] ); //yes, this is async and that's okey
                  }

                  document.getElementById( "scenario_sel" ).addEventListener('click',function() {
                      var seld = document.getElementById( "scenario_sel" ).value;
                      var sels = app.get( 'scenarios' ).toArray();
                      selectScene( sels[seld], seld );
                   } );
                  
                  document.getElementById( "new_scene" ).addEventListener('click',function() {
                      yote.callWorker( {
                          callpath : 'new_scene',
                          callback : function( news ) {
                              updateScenes();
                              selectScene( news );
                          }
                      } );
                  } )

                  document.getElementById( "RESET" ).addEventListener('click',function() {
                      if( confirm( 'really delete everything?' ) ) {
                          yote.callWorker( {
                              callpath : 'reset',
                              callback : function( resp ) {
                                  updateScenes();
                                  selectScene( app.get('scenarios').get(0) );
                              }
                          } );
                      }
                  } );

                  document.getElementById( "calc" ).addEventListener('click',function() {
                      yote.callWorker( {
                          callpath : 'calc',
                          params    : {
                              number_employees : document.getElementById( 'numEmpl' ).value,
                              hourly_wage      : document.getElementById( 'wage' ).value
                          },
                          callback : function( response ) {
                              // this response has the result of the calculation state
                              // is stored in the response object's calcResult field
                              document.getElementById( "hourCost" ).innerHTML = response.get( 'calcResult' );
                          }
                      } );
                  } );

                  document.getElementById( "sceneName" ).addEventListener( 'keypress', function(ev) {
                      if( ev.keyCode == 13 || ev.charCode == 13 ) {
                          currScene.update( [{ name : this.value }], function() {
                              updateScenes();
                          } );
                      }
                  } );
                  updateScenes();
                  var sels = app.get( 'scenarios' ).toArray();
                  var currIdx = app.get( 'current_scene_idx' ) || 0;
                  var currScene = sels[currIdx];
                  selectScene( currScene, currIdx );
              }
          ] )
              .fail( 1, function() { console.log( "Step 1 failed" ) } )
              .fail( '++*', function() { console.log( "Before any failure do this" ) } )
              .fail( '*++', function() { console.log( "After any failure do this" ) } )
              .fail( '*', function() { console.log( "Do this failure unles the step has a specific error message" ) } )
              .start();
      }
    </script>

  </head>
  <body onLoad="init()">
    <h1>Production Line Scenario Manager</h1>

    <button type="button" id="RESET">RESET</button>
    <BR><BR>
Available Scenarios <select id="scenario_sel"></select>
    <button type="button" id="new_scene">Create New Scenario</button> <BR>

Scenario Name <input type="text" id="sceneName"> <br>


    <br> (test area ) <br>
    Number of Employees <input type="number" id="numEmpl"><br>
    Hourly Wage <input type="number" id="wage"> <br>
    
    <div style="border:1px solid black; display:inline-block">
       <div id="hourCost"></div>
    </div>

    <button type="button" id="calc">Calc</button> <br>

  </body>
</html>
